<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zorgstart ‚Äî Slimme intake (wizard + taken + print)</title>
  <meta name="description" content="Slimme intake: wizard flow + probleemgebieden + concrete taken + printbaar zorgplan." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f9fc;
      --panel: rgba(10,47,94,.04);
      --border:#d7e2f0;
      --text:#123047;
      --muted:#5b7288;
      --faint:#8aa0b3;
      --accent:#0b63ce;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --r:14px;
      --shadow: 0 18px 45px rgba(10,47,94,0.06);
      --max:1160px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(11,99,206,.10), transparent 55%),
        radial-gradient(900px 600px at 85% 18%, rgba(11,99,206,.08), transparent 60%),
        radial-gradient(800px 560px at 60% 90%, rgba(22,163,74,.10), transparent 55%),
        linear-gradient(180deg,#f6f9fc,#f6f9fc);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 18px 60px}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:#fff; border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:var(--max); margin:0 auto;
      padding:12px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .dot{
      width:11px; height:11px; border-radius:50%;
      background: linear-gradient(135deg,var(--accent),#2a8cff);
      box-shadow:0 0 0 4px rgba(11,99,206,.12);
    }
    .badge{
      font-size:12px; font-weight:800;
      padding:4px 10px; border-radius:999px;
      background:#eef4ff; border:1px solid var(--border);
      color:var(--muted);
    }
    .spacer{flex:1}
    .pill{
      font-size:12px; font-weight:800;
      padding:7px 11px; border-radius:999px;
      background:#f8fafc; border:1px solid var(--border);
      color:var(--muted);
      display:inline-flex; gap:8px; align-items:center;
    }
    .hero{
      margin-top:16px;
      border:1px solid var(--border);
      border-radius: calc(var(--r) + 6px);
      background: linear-gradient(180deg, rgba(11,99,206,.08), rgba(255,255,255,.92));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero-inner{padding:22px}
    h1{margin:0 0 10px; font-size:26px; letter-spacing:-.2px}
    .lead{margin:0; color:var(--muted); line-height:1.45}

    /* Steps */
    .navsteps{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
    }
    .step{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .num{
      width:26px; height:26px;
      border-radius:10px;
      display:grid; place-items:center;
      font-weight:900;
      background:#eef4ff;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .step b{font-size:13px}
    .step span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .step.active{border-color:rgba(11,99,206,.35); background:rgba(11,99,206,.06)}
    .step.done .num{color:var(--good); border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.10)}
    .right-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#eef4ff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background: var(--accent);
      color:#fff;
      border-color: rgba(11,99,206,.35);
    }
    .btn:active{transform:translateY(1px)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--border);
      border-radius: var(--r);
      background:#fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      display:flex; gap:12px; justify-content:space-between; align-items:flex-start;
    }
    .card-h h2{margin:0; font-size:14px; letter-spacing:.2px}
    .sub{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .card-b{padding:16px}
    .mini{font-size:12px; color:var(--muted)}

    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 760px){ .form-grid{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      color:var(--text);
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(11,99,206,.45);
      box-shadow: 0 0 0 4px rgba(11,99,206,.12);
    }
    .help{margin-top:6px; font-size:12px; color:var(--faint); line-height:1.35}

    .section{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#f8fafc;
      overflow:hidden;
    }
    .sec-h{
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer; user-select:none;
    }
    .ttl{display:flex; align-items:center; gap:10px; font-weight:900; font-size:13px}
    .ico{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background:rgba(11,99,206,.08);
      border:1px solid rgba(11,99,206,.16);
      color:var(--accent);
      font-weight:900;
    }
    .meta{font-size:12px; color:var(--muted)}
    .sec-b{
      border-top:1px solid var(--border);
      padding:12px;
      display:none;
      background:#fff;
    }
    .section[data-open="1"] .sec-b{display:block}

    .checks{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 760px){ .checks{grid-template-columns:1fr} }
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
    }
    .check input{width:auto; margin-top:2px; accent-color: var(--accent)}
    .check b{display:block; font-size:13px}
    .check span{display:block; font-size:12px; color:var(--muted); margin-top:2px; line-height:1.3}

    .reveal{
      margin-top:10px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed var(--border);
      background:#f8fafc;
      display:none;
    }
    .reveal[data-show="1"]{display:block}

    /* Output */
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .stat{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
    }
    .stat .n{font-size:22px; font-weight:900}
    .stat .t{margin-top:2px; font-size:12px; color:var(--muted)}
    .tag{
      font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:var(--muted);
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .tag.good{border-color:rgba(22,163,74,.25); color:var(--good); background:rgba(22,163,74,.10)}
    .tag.warn{border-color:rgba(245,158,11,.25); color:var(--warn); background:rgba(245,158,11,.10)}
    .tag.bad{border-color:rgba(239,68,68,.25); color:var(--bad); background:rgba(239,68,68,.10)}
    .outTabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .outTab{
      border:1px solid var(--border);
      background:#eef4ff;
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .outTab.active{
      border-color:rgba(11,99,206,.35);
      background:rgba(11,99,206,.10);
    }
    .outPanel{margin-top:10px}
    .hidden{display:none!important}

    /* Tasks */
    .tasksHead{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }
    .taskBoard{margin-top:10px; display:grid; grid-template-columns:1fr; gap:10px}
    .taskGroup{
      padding:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
    }
    .taskGroupTop{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .taskGroupTitle{font-weight:900}
    .taskList{margin-top:10px; display:flex; flex-direction:column; gap:8px}
    .task{
      padding:10px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#f8fafc;
    }
    .taskLine{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .taskLine b{font-size:13px}
    .taskMeta{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .chipSelect{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:900;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#eef4ff;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chipSelect input{margin:0; accent-color:var(--accent)}
    pre{
      margin:12px 0 0;
      padding:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#f0f3f8;
      color:#374151;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    /* Print (main page) */
    @media print{
      body{background:#fff; color:#111}
      .topbar,.hero,.navsteps,.right-actions{display:none!important}
      .wrap{max-width:100%; padding:0}
      .grid{grid-template-columns:1fr!important}
      .card{box-shadow:none!important}
      .section,.stat,.taskGroup,.task{break-inside:avoid}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span class="dot"></span><span>Zorgstart</span><span class="badge">Slimme intake</span></div>
      <div class="spacer"></div>
      <span class="pill">Wizard ‚Ä¢ Aandachtsgebieden ‚Ä¢ Taken ‚Ä¢ Zorgplan</span>
    </div>
  </div>

  <div class="wrap">
    <section class="hero">
      <div class="hero-inner">
        <h1>Veilig-thuis intake ‚Äî eenvoudig en taakgericht</h1>
        <p class="lead">
          Je vinkt signalen aan ‚Üí het systeem maakt <b>concrete taken</b>. Taken blijven simpel:
          <b>titel</b>, <b>uitvoerder</b> en <b>signaal</b>. Nurseline-co√∂rdinatie enkel als dit expliciet gevraagd is.
        </p>
      </div>
    </section>

    <div class="navsteps" id="navSteps">
      <div class="step active" data-step="1" role="button" tabindex="0">
        <div class="num">1</div><div><b>Basis</b><span>identiteit & context</span></div>
      </div>
      <div class="step" data-step="2" role="button" tabindex="0">
        <div class="num">2</div><div><b>Probleemgebieden</b><span>signaleren</span></div>
      </div>
      <div class="step" data-step="3" role="button" tabindex="0">
        <div class="num">3</div><div><b>Samenvatting</b><span>export & zorgplan</span></div>
      </div>

      <div class="spacer"></div>
      <div class="right-actions">
        <button class="btn" type="button" id="btnCopy">Kopieer JSON</button>
        <button class="btn" type="button" id="btnPrint">Print pagina</button>
        <button class="btn primary" type="button" id="btnCarePlan">Zorgplan (print/PDF)</button>
        <button class="btn" type="button" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="card-h">
          <div>
            <h2 id="leftTitle">Stap 1 ‚Äî Basis</h2>
            <p class="sub" id="leftSub">Minimale gegevens. Daarna signalen aanvinken.</p>
          </div>
          <span class="badge" id="statusBadge">Start</span>
        </div>

        <div class="card-b">
          <form id="zsForm" autocomplete="on">
            <!-- STEP 1 -->
            <div id="step1">
              <div class="form-grid">
                <div>
                  <label>Naam</label>
                  <input name="naam" placeholder="Voornaam + naam" />
                </div>
                <div>
                  <label>Rijksregisternummer</label>
                  <input name="rrn" placeholder="xx.xx.xx-xxx.xx" />
                </div>
                <div>
                  <label>Telefoon</label>
                  <input name="tel" placeholder="+32..." />
                </div>
                <div>
                  <label>Mutualiteit</label>
                  <input name="mut" placeholder="bv. CM, Solidaris..." />
                </div>
                <div style="grid-column:1/-1">
                  <label>Adres</label>
                  <input name="adres" placeholder="Straat + nr, postcode, gemeente" />
                </div>
                <div>
                  <label>Huisarts</label>
                  <input name="huisarts" placeholder="Naam arts (optioneel)" />
                </div>
                <div>
                  <label>Mantelzorg / contactpersoon</label>
                  <input name="mantel" placeholder="Naam + tel (optioneel)" />
                </div>
                <div style="grid-column:1/-1">
                  <label>Context (kort)</label>
                  <textarea name="context" placeholder="Reden opname/ontslagcontext, relevante info..." rows="2"></textarea>
                </div>
              </div>

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button type="button" class="btn primary" id="next1">Naar probleemgebieden</button>
              </div>
            </div>

            <!-- STEP 2 -->
            <div id="step2" class="hidden">
              <div class="mini">Openklapbaar. Vink signalen aan; taken worden rechts live aangemaakt.</div>

              <!-- SOCIAAL: NURSELINE COORD -->
              <div class="section" data-open="1" data-section="nurseline">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üìû</span> Co√∂rdinatie</div>
                  <div class="meta" id="meta-nurseline">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="check">
                    <input type="checkbox" name="nl_coord" data-reveal="#rev-nl" />
                    <div>
                      <b>Co√∂rdinatie door Nurseline (zorco√∂rdinator) gevraagd?</b>
                      <span>Enkel bij ‚Äúja‚Äù wordt er een Nurseline-co√∂rdinatie-taak aangemaakt.</span>
                    </div>
                  </div>
                  <div class="reveal" id="rev-nl">
                    <label>Waarvoor precies (heel concreet)?</label>
                    <input name="nl_coord_why" placeholder="bv. opvolging thuisverpleging, afstemming huisarts/apotheek, ondersteuningsmateriaal, therapie-trouw, planning opvolgmomenten..." />
                  </div>
                </div>
              </div>

              <!-- MOBILITEIT -->
              <div class="section" data-open="0" data-section="mobiliteit">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üö∂</span> Mobiliteit & val</div>
                  <div class="meta" id="meta-mobiliteit">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="mob_stappen" data-pb="Mobiliteit" data-score="2" data-reveal="#rev-mob-aid" />
                      <div><b>Moeilijk stappen</b><span>instabiel / korte afstand</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="mob_transfers" data-pb="Mobiliteit" data-score="2" data-reveal="#rev-transfer" />
                      <div><b>Transfers moeilijk</b><span>bed/stoel/toilet</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="mob_val" data-pb="Valrisico" data-score="3" data-reveal="#rev-val" />
                      <div><b>Valincident recent</b><span>val of bijna-val met impact</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_alleen" data-pb="Wooncontext" data-score="3" data-reveal="#rev-alleen" />
                      <div><b>Alleenwonend</b><span>weinig/geen steun</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-mob-aid">
                    <label>Hulpmiddel?</label>
                    <select name="mob_hulpmiddel">
                      <option value="">Kies‚Ä¶</option>
                      <option>Geen</option>
                      <option>Stok</option>
                      <option>Rollator</option>
                      <option>Rolstoel</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <div class="reveal" id="rev-transfer">
                    <div class="form-grid">
                      <div>
                        <label>Transfers: hulp nodig?</label>
                        <select name="transfer_hulp">
                          <option value="">Kies‚Ä¶</option>
                          <option>Nee</option>
                          <option>Ja, 1 persoon</option>
                          <option>Ja, 2 personen / tillift</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Tillift / glijmat?</label>
                        <select name="transfer_tools">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-alleen">
                    <div class="form-grid">
                      <div>
                        <label>Dagelijks contact mogelijk?</label>
                        <select name="alleen_contact">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Toegang (sleutel/kluis) geregeld?</label>
                        <select name="toegang">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja, code na te vragen</option>
                          <option>Nee, graag nakijken</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- MEDICATIE -->
              <div class="section" data-open="0" data-section="medicatie">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üíä</span> Medicatie</div>
                  <div class="meta" id="meta-medicatie">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="form-grid">
                    <div>
                      <label>Aantal medicaties</label>
                      <input type="number" name="med_aantal" min="0" placeholder="bv. 7" />
                    </div>
                  </div>

                  <div class="checks" style="margin-top:10px;">
                    <label class="check">
                      <input type="checkbox" name="cog_medicatievergeet" data-pb="Medicatie" data-score="2" data-reveal="#rev-med-adherentie" />
                      <div><b>Medicatie wordt vergeten</b><span>therapietrouw onzeker</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_overzicht" data-pb="Medicatie" data-score="1" data-reveal="#rev-med-schema-missing" />
                      <div><b>Actueel schema ontbreekt</b><span>niet beschikbaar</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_anticoag" data-pb="Medicatie" data-score="2" data-reveal="#rev-med-anticoag" />
                      <div><b>Anticoagulatie</b><span>NOAC/VKA/LMWH</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_inject" data-pb="Technische zorg" data-score="2" data-reveal="#rev-med-inject" />
                      <div><b>Injecties nodig</b><span>insuline of andere</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-med-adherentie">
                    <div class="form-grid">
                      <div>
                        <label>Kan pati√´nt zelf beheren?</label>
                        <select name="med_self">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja, zelfstandig</option>
                          <option>Gedeeltelijk</option>
                          <option>Nee, graag dispenser of innamedoosje voorzien</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Risico op verwarring?</label>
                        <select name="med_confusion">
                          <option value="">Kies‚Ä¶</option>
                          <option>Laag</option>
                          <option>Middel</option>
                          <option>Hoog</option>
                          <option>Cave - slaapmedicatie</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-med-schema-missing">
                    <label>Wie kan schema bezorgen?</label>
                    <select name="schema_bron">
                      <option value="">Kies‚Ä¶</option>
                      <option>Huisarts</option>
                      <option>Apotheek</option>
                      <option>Ziekenhuis / ontslagbrief</option>
                      <option>Mantelzorger</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <div class="reveal" id="rev-med-anticoag">
                    <div class="form-grid">
                      <div>
                        <label>Type</label>
                        <select name="anticoag_type">
                          <option value="">Kies‚Ä¶</option>
                          <option>NOAC</option>
                          <option>Vitamine K antagonist</option>
                          <option>LMWH</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Opvolging geregeld?</label>
                        <select name="anticoag_follow">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-med-inject">
                    <div class="form-grid">
                      <div>
                        <label>Frequentie</label>
                        <select name="inject_freq">
                          <option value="">Kies‚Ä¶</option>
                          <option>Dagelijks</option>
                          <option>Meerdere keren per dag</option>
                          <option>Wekelijks</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Kan pati√´nt zelf injecteren?</label>
                        <select name="inject_self">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Upload medicatieschema -->
                  <div class="section" style="margin-top:10px;" data-open="1" data-section="medschema">
                    <div class="sec-h" style="cursor:pointer">
                      <div class="ttl"><span class="ico">üìé</span> Medicatieschema upload</div>
                      <div class="meta" id="meta-medschema">‚Äî</div>
                    </div>
                    <div class="sec-b" style="display:block;">
                      <label>Upload (PDF/DOC/DOCX)</label>
                      <input type="file" id="medSchemaFile"
                        accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
                      <div class="help">
                        Na upload maken we een taak: ‚ÄúBCFI-check (www.bcfi.be)‚Äù. Je kan hieronder belangrijke aandachtspunten ingeven.
                      </div>

                      <div style="margin-top:10px;">
                        <label>BCFI aandachtspunten (1 per regel)</label>
                        <textarea name="med_bcfi_lines"
                          placeholder="Voorbeeld:
- Interactie X ‚Üí opvolgen
- Nierfunctie: dosis aanpassen
- Bloedingsrisico door anticoagulatie"></textarea>
                        <div class="help">
                          Klik ‚ÄúTaken maken uit BCFI‚Äù om per regel een taak aan te maken.
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                          <button class="btn" type="button" id="btnBcfiTasks">Taken maken uit BCFI</button>
                          <span class="mini" id="bcfiTasksHint">‚Äî</span>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- TECHNISCHE ZORG (kort) -->
              <div class="section" data-open="0" data-section="technisch">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">ü©∫</span> Technische zorg</div>
                  <div class="meta" id="meta-technisch">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="tech_wonde" data-pb="Wondzorg" data-score="2" data-reveal="#rev-wonde" />
                      <div><b>Wondzorg nodig</b><span>verband/controle</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="tech_katheter" data-pb="Technische zorg" data-score="2" data-reveal="#rev-kath" />
                      <div><b>Katheterzorg</b><span>opvolging/afspraken</span></div>
                    </label>
                  </div>
                  <div class="reveal" id="rev-wonde">
                    <div class="form-grid">
                      <div>
                        <label>Type wonde</label>
                        <select name="wonde_type">
                          <option value="">Kies‚Ä¶</option>
                          <option>Postoperatief</option>
                          <option>Trauma</option>
                          <option>Ulcus</option>
                          <option>skintears</option>
                          <option>doorligwonden</option>
                        </select>
                      </div>
                      <div>
                        <label>Frequentie zorg</label>
                        <select name="wonde_freq">
                          <option value="">Kies‚Ä¶</option>
                          <option>Dagelijks</option>
                          <option>Om de 2 dagen</option>
                          <option>2‚Äì3x/week</option>
                          <option>Wekelijks</option>
                          <option>Wisselhouding</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="reveal" id="rev-kath">
                    <label>Type katheter</label>
                    <select name="katheter_type">
                      <option value="">Kies‚Ä¶</option>
                      <option>Blaaskatheter</option>
                      <option>Suprapubisch</option>
                      <option>Condoomkatheter</option>
                      <option>Onbekend</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- OPM -->
              <div class="section" data-open="0" data-section="opm">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üìù</span> Opmerking</div>
                  <div class="meta" id="meta-opm">‚Äî</div>
                </div>
                <div class="sec-b">
                  <label>Vrije opmerking (kort)</label>
                  <textarea name="opm" placeholder="Wat moeten we zeker weten?"></textarea>
                </div>
              </div>

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button type="button" class="btn" id="back2">Terug</button>
                <button type="button" class="btn primary" id="next2">Naar samenvatting</button>
              </div>
            </div>

            <!-- STEP 3 -->
            <div id="step3" class="hidden">
              <div class="mini">Controleer rechts de taken en exporteer indien nodig.</div>
              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button type="button" class="btn" id="back3">Terug</button>
                <button type="button" class="btn primary" id="btnFinalCopy">Kopieer JSON</button>
                <button type="button" class="btn" id="btnFinalPrint">Print pagina</button>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="card-h">
          <div>
            <h2>Output (live)</h2>
            <p class="sub">Probleemgebieden + taken (simpel) + JSON</p>
          </div>
          <span class="tag" id="severityBadge">‚Äî</span>
        </div>

        <div class="card-b">
          <div class="kpi">
            <div class="stat">
              <div class="n" id="scoreTotal">0</div>
              <div class="t">Kwetsbaarheidsscore (prototype)</div>
            </div>
            <div class="stat">
              <div class="n" id="pbCount">0</div>
              <div class="t">Actieve probleemgebieden</div>
            </div>
          </div>

          <div class="outTabs">
            <button class="outTab active" type="button" data-tab="taken">Taken</button>
            <button class="outTab" type="button" data-tab="json">JSON</button>
          </div>

          <div class="outPanel" data-panel="taken">
            <div class="tasksHead">
              <div>
                <b>Concreet takenpakket</b>
                <div class="mini">Taken = titel + uitvoerder + signaal. Manueel toevoegen kan ook.</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <span class="pill" id="taskCountPill">0 taken</span>
                <button class="btn" type="button" id="btnAddTask">+ Taak</button>
              </div>
            </div>

            <div id="taskBoard" class="taskBoard"></div>
          </div>

          <div class="outPanel hidden" data-panel="json">
            <pre id="jsonOut">{}</pre>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ==========================================================
   Zorgstart ‚Äî Slimme intake (Keep it simple)
   - Taken ONLY: titel + uitvoerder + signaal (en selectie voor zorgplan)
   - Nurseline-co√∂rdinatie taak enkel als expliciet gevraagd (nl_coord = true)
   - Medicatieschema upload -> BCFI-check taak
   - BCFI aandachtspunten (1 per regel) -> per regel taak aanmaken
   ========================================================== */

const $  = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const form = $("#zsForm");

// Wizard
const stepEls = {1: $("#step1"), 2: $("#step2"), 3: $("#step3")};
const stepsNav = $$(".step", $("#navSteps"));
const leftTitle = $("#leftTitle");
const leftSub = $("#leftSub");
const statusBadge = $("#statusBadge");

// Output
const scoreTotalEl = $("#scoreTotal");
const pbCountEl = $("#pbCount");
const severityBadge = $("#severityBadge");
const jsonOut = $("#jsonOut");
const taskBoard = $("#taskBoard");
const taskCountPill = $("#taskCountPill");

// Tabs
const tabBtns = $$(".outTab");
const panels = $$(".outPanel");

// Memory
window.__ZS_MANUAL_TASKS = window.__ZS_MANUAL_TASKS || [];
window.__ZS_MED_SCHEMA_FILE = window.__ZS_MED_SCHEMA_FILE || null;
window.__ZS_BCFI_TASKS = window.__ZS_BCFI_TASKS || []; // tasks created from lines

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}
function newId(prefix="T"){ return prefix + "_" + Math.random().toString(36).slice(2,9).toUpperCase(); }
function severityTag(score){
  if(score >= 10) return {cls:"bad", txt:"hoog"};
  if(score >= 6) return {cls:"warn", txt:"matig"};
  return {cls:"good", txt:"laag"};
}
function groupBy(arr, keyFn){
  const m = new Map();
  arr.forEach(x => {
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  });
  return m;
}

// Sections open/close + reveal
function toggleSection(el){
  const sec = el.closest(".section");
  if(!sec) return;
  const open = sec.getAttribute("data-open") === "1";
  sec.setAttribute("data-open", open ? "0" : "1");
}
function updateRevealForInput(inp){
  const sel = inp.getAttribute("data-reveal");
  if(!sel) return;
  const rev = $(sel);
  if(!rev) return;
  const show = (inp.type === "checkbox") ? inp.checked : !!inp.value;
  rev.setAttribute("data-show", show ? "1" : "0");
}
function updateMeta(){
  // meta per section = aantal aangevinkte checkboxes binnen die section
  $$(".section").forEach(sec => {
    const key = sec.getAttribute("data-section");
    const metaEl = $("#meta-" + key);
    if(!metaEl) return;
    const checked = $$("input[type=checkbox]", sec).filter(x => x.checked).length;
    metaEl.textContent = checked ? `${checked} signal(en)` : "‚Äî";
  });
  // medscehma meta
  const ms = window.__ZS_MED_SCHEMA_FILE;
  const msMeta = $("#meta-medschema");
  if(msMeta) msMeta.textContent = ms ? "opgeladen" : "‚Äî";
}

// Data + score
function collectData(){
  const data = {};
  const fd = new FormData(form);
  for(const [k,v] of fd.entries()){
    if(v !== "") data[k] = v;
  }
  $$("input[type=checkbox]", form).forEach(c => data[c.name] = !!c.checked);
  return data;
}
function computePB(){
  const pbScores = {};
  let total = 0;

  $$("input[type=checkbox][data-pb]", form).forEach(c => {
    if(!c.checked) return;
    const pb = c.getAttribute("data-pb");
    const s = Number(c.getAttribute("data-score") || "1");
    pbScores[pb] = (pbScores[pb] || 0) + s;
    total += s;
  });

  // simple medication scoring from fields too
  const medAantal = Number((form.elements["med_aantal"]?.value || "0"));
  const medComplex = (form.elements["med_complex"]?.value || "");
  if(medAantal > 5){ pbScores["Medicatie"] = (pbScores["Medicatie"] || 0) + 2; total += 2; }
  if(medComplex && medComplex.startsWith("Ja")){ pbScores["Medicatie"] = (pbScores["Medicatie"] || 0) + 1; total += 1; }

  return {pbScores, total};
}

// Tasks (simple schema)
function buildAutoTasks(data, pbScores){
  const tasks = [];
  const add = ({id, group="Algemeen", title, uitvoerder="‚Äî", signaal="‚Äî"}) => {
    if(!title) return;
    tasks.push({ id: id || newId("AUTO"), group, title, uitvoerder, signaal, selected:true });
  };

  const isChecked = (name) => !!$("input[name='"+name+"']")?.checked;
  const v = (name) => (form.elements[name]?.value || "");

  // --- Nurseline coordination ONLY if explicit
  if(isChecked("nl_coord")){
    add({
      id:"NL_COORD",
      group:"Co√∂rdinatie (Nurseline)",
      title:"Nurseline co√∂rdinatie opstarten",
      uitvoerder:"Nurseline",
      signaal: v("nl_coord_why") ? v("nl_coord_why") : "Co√∂rdinatie gevraagd (details ontbreken)"
    });
  }

  // --- Medication: request/validate schema if risk signals
  const medRisk = (
    Number(v("med_aantal") || "0") > 5 ||
    (v("med_complex") || "").startsWith("Ja") ||
    isChecked("cog_medicatievergeet") ||
    isChecked("med_overzicht") ||
    isChecked("med_anticoag") ||
    isChecked("med_inject")
  );
  if(medRisk){
    add({
      id:"MED_SCHEMA",
      group:"Medicatie",
      title:"Medicatieschema opvragen/valideren",
      uitvoerder:"Apotheek of huisarts",
      signaal: [
        (v("med_aantal") ? `Medicaties: ${v("med_aantal")}` : ""),
        (v("med_complex") ? `Complex: ${v("med_complex")}` : ""),
        (isChecked("cog_medicatievergeet") ? "Therapietrouw onzeker" : ""),
        (isChecked("med_overzicht") ? `Schema ontbreekt (bron: ${v("schema_bron") || "onbekend"})` : ""),
        (isChecked("med_anticoag") ? `Anticoagulatie (${v("anticoag_type") || "onbekend"})` : ""),
        (isChecked("med_inject") ? `Injecties (${v("inject_freq") || "onbekend"})` : "")
      ].filter(Boolean).join(" | ") || "Medicatiecomplexiteit/risico aangeduid"
    });
  }

  // --- Upload -> BCFI check task
  if(window.__ZS_MED_SCHEMA_FILE){
    add({
      id:"MED_BCFI_CHECK",
      group:"Medicatie",
      title:"BCFI-check medicatieschema (www.bcfi.be)",
      uitvoerder:"Nurseline (met apotheek/huisarts indien nodig)",
      signaal:`Schema opgeladen: ${window.__ZS_MED_SCHEMA_FILE.name}`
    });
  }

  // --- Mobility/fall
  if(isChecked("mob_val") || isChecked("mob_stappen") || isChecked("mob_transfers")){
    add({
      id:"MOB_FALL",
      group:"Mobiliteit/Val",
      title:"Val- en mobiliteitsrisico bevestigen + preventieadvies",
      uitvoerder:"Verpleegkundige (N6) of Nurseline",
      signaal: [
        (isChecked("mob_val") ? `Val: ${v("val_aantal")||"onbekend"} (letsel: ${v("val_letsel")||"onbekend"})` : ""),
        (isChecked("mob_stappen") ? `Stappen moeilijk (hulpmiddel: ${v("mob_hulpmiddel")||"onbekend"})` : ""),
        (isChecked("mob_transfers") ? `Transfers (hulp: ${v("transfer_hulp")||"onbekend"}, tools: ${v("transfer_tools")||"onbekend"})` : "")
      ].filter(Boolean).join(" | ") || "Mobiliteit/valrisico aangeduid"
    });
  }

  if((v("mob_hulpmiddel") && v("mob_hulpmiddel") !== "Geen" && v("mob_hulpmiddel") !== "") || v("transfer_tools")==="Te voorzien"){
    add({
      id:"MOB_AID",
      group:"Mobiliteit/Val",
      title:"Hulpmiddel(en) voorzien/aanvragen",
      uitvoerder:"Ergotherapie of thuiszorgwinkel",
      signaal: [
        (v("mob_hulpmiddel") && v("mob_hulpmiddel") !== "Geen" ? `Hulpmiddel: ${v("mob_hulpmiddel")}` : ""),
        (v("transfer_tools")==="Te voorzien" ? "Transferhulpmiddel te voorzien" : "")
      ].filter(Boolean).join(" | ") || "Hulpmiddel nodig"
    });
  }

  // Alone living (simple task)
  if(isChecked("soc_alleen")){
    add({
      id:"ALONE_ACCESS",
      group:"Wooncontext",
      title:"Dagelijks contact + toegang/sleutelbeheer bevestigen",
      uitvoerder:"Nurseline",
      signaal: `Contact: ${v("alleen_contact")||"onbekend"} | Toegang: ${v("toegang")||"onbekend"}`
    });
  }

  // Technical care
  if(isChecked("tech_wonde")){
    add({
      id:"WOUND",
      group:"Technische zorg",
      title:"Wondzorg opstarten (protocol + materiaal)",
      uitvoerder:"Thuisverpleegkundige",
      signaal:`Type: ${v("wonde_type")||"onbekend"} | Frequentie: ${v("wonde_freq")||"onbekend"}`
    });
  }
  if(isChecked("tech_katheter")){
    add({
      id:"CATH",
      group:"Technische zorg",
      title:"Katheterzorg afspraken vastleggen",
      uitvoerder:"Thuisverpleegkundige",
      signaal:`Type: ${v("katheter_type")||"onbekend"}`
    });
  }

  return tasks;
}

// Manual task creation (simple fields)
function addManualTask(){
  const title = prompt("Taak (titel) ‚Äî zo concreet mogelijk:");
  if(!title || !title.trim()) return;

  const uitvoerder = prompt("Uitvoerder (bv. Nurseline / thuisverpleegkundige / apotheek):") || "‚Äî";
  const signaal = prompt("Signaal (waarom deze taak? zo concreet mogelijk):") || "‚Äî";

  window.__ZS_MANUAL_TASKS.push({
    id: newId("MAN"),
    group: "Manueel",
    title: title.trim(),
    uitvoerder: (uitvoerder || "‚Äî").trim(),
    signaal: (signaal || "‚Äî").trim(),
    selected: true
  });
  renderOutput();
}
$("#btnAddTask").addEventListener("click", addManualTask);

// BCFI line tasks
function createTasksFromBcfiLines(){
  const raw = (form.elements["med_bcfi_lines"]?.value || "").trim();
  const hint = $("#bcfiTasksHint");
  if(!raw){
    if(hint) hint.textContent = "Geen BCFI-regels ingevuld.";
    return;
  }
  const lines = raw
    .split(/\r?\n/)
    .map(l => l.replace(/^[-‚Ä¢]\s*/,"").trim())
    .filter(Boolean);

  if(!lines.length){
    if(hint) hint.textContent = "Geen bruikbare regels gevonden.";
    return;
  }

  // One task per line (simple: title + uitvoerder + signaal)
  const tasks = lines.map((line, idx) => ({
    id: newId("BCFI"),
    group: "Medicatie",
    title: "BCFI aandachtspunt opvolgen",
    uitvoerder: "Nurseline",
    signaal: line,
    selected: true
  }));

  // Merge: keep existing BCFI tasks, add new
  window.__ZS_BCFI_TASKS = (window.__ZS_BCFI_TASKS || []).concat(tasks);

  if(hint) hint.textContent = `${tasks.length} taak/taken aangemaakt uit BCFI.`;
  renderOutput();
}
$("#btnBcfiTasks").addEventListener("click", createTasksFromBcfiLines);

// File upload
$("#medSchemaFile").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  window.__ZS_MED_SCHEMA_FILE = f ? { name:f.name, type:f.type, size:f.size } : null;
  updateMeta();
  renderOutput();
});

// Render tasks
function renderTasks(tasks){
  taskBoard.innerHTML = "";

  const selectedCount = tasks.filter(t => t.selected !== false).length;
  taskCountPill.textContent = `${selectedCount} / ${tasks.length} taken`;

  if(!tasks.length){
    taskBoard.innerHTML = `
      <div class="taskGroup">
        <div class="taskGroupTop">
          <div class="taskGroupTitle">Nog geen taken</div>
          <span class="tag">‚Äî</span>
        </div>
        <div class="mini" style="margin-top:8px;">Vink signalen aan of vul velden in om taken te genereren.</div>
      </div>`;
    return;
  }

  const grouped = groupBy(tasks, t => t.group || "Algemeen");
  grouped.forEach((items, group) => {
    const g = document.createElement("div");
    g.className = "taskGroup";
    g.innerHTML = `
      <div class="taskGroupTop">
        <div class="taskGroupTitle">${escapeHtml(group)}</div>
        <span class="tag">${items.length} taken</span>
      </div>
      <div class="taskList">
        ${items.map(t => {
          const checked = (t.selected !== false) ? "checked" : "";
          const isManual = String(t.id || "").startsWith("MAN_");
          const isBcfi   = String(t.id || "").startsWith("BCFI_");
          const canDelete = isManual || isBcfi;
          return `
            <div class="task">
              <div class="taskLine">
                <div>
                  <b>${escapeHtml(t.title)}</b>
                  <div class="taskMeta">Uitvoerder: ${escapeHtml(t.uitvoerder || "‚Äî")}</div>
                  <div class="taskMeta">Signaal: ${escapeHtml(t.signaal || "‚Äî")}</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <label class="chipSelect" title="Opnemen in zorgplan">
                    <input type="checkbox" data-task-select="${escapeHtml(t.id)}" ${checked}>
                    In zorgplan
                  </label>
                  ${canDelete ? `<button class="btn" type="button" data-task-del="${escapeHtml(t.id)}">‚úï</button>` : ""}
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    taskBoard.appendChild(g);
  });

  // selection toggle
  taskBoard.querySelectorAll("input[data-task-select]").forEach(inp => {
    inp.addEventListener("change", (e) => {
      const id = e.target.getAttribute("data-task-select");
      const out = window.__ZS_OUT;
      if(!out || !out.taken) return;
      const t = out.taken.find(x => x.id === id);
      if(!t) return;
      t.selected = e.target.checked;
      jsonOut.textContent = JSON.stringify(out, null, 2);
      renderTasks(out.taken);
    });
  });

  // delete manual or BCFI tasks
  taskBoard.querySelectorAll("button[data-task-del]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const id = e.currentTarget.getAttribute("data-task-del");
      window.__ZS_MANUAL_TASKS = (window.__ZS_MANUAL_TASKS || []).filter(t => t.id !== id);
      window.__ZS_BCFI_TASKS  = (window.__ZS_BCFI_TASKS  || []).filter(t => t.id !== id);
      renderOutput();
    });
  });
}

// Output render
function renderOutput(){
  const data = collectData();
  const {pbScores, total} = computePB();
  updateMeta();

  const pbKeys = Object.keys(pbScores).sort((a,b) => pbScores[b] - pbScores[a]);
  const autoTasks = buildAutoTasks(data, pbScores);
  const manual = window.__ZS_MANUAL_TASKS || [];
  const bcfiTasks = window.__ZS_BCFI_TASKS || [];
  let tasks = [...autoTasks, ...bcfiTasks, ...manual];

  // Keep selection state across renders
  const prev = window.__ZS_OUT?.taken || [];
  const selMap = new Map(prev.map(t => [t.id, t.selected !== false]));
  tasks.forEach(t => { if(selMap.has(t.id)) t.selected = selMap.get(t.id); });

  const sev = severityTag(total);
  severityBadge.className = `tag ${sev.cls}`;
  severityBadge.textContent = `Kwetsbaarheid: ${sev.txt}`;

  statusBadge.textContent = total ? `Score ${total}` : "Start";
  scoreTotalEl.textContent = String(total);
  pbCountEl.textContent = String(pbKeys.length);

  const out = {
    patient: {
      naam: data.naam || "",
      rrn: data.rrn || "",
      tel: data.tel || "",
      mutualiteit: data.mut || "",
      adres: data.adres || "",
      huisarts: data.huisarts || "",
      mantel: data.mantel || "",
      context: data.context || ""
    },
    probleemgebieden: pbKeys.map(k => ({ key:k, score: pbScores[k] })),
    kwetsbaarheidScore: total,
    nurselineCoordGevraagd: !!data.nl_coord,
    medicatieschema: window.__ZS_MED_SCHEMA_FILE || null,
    taken: tasks,
    opmerking: data.opm || ""
  };

  window.__ZS_OUT = out;
  renderTasks(tasks);
  jsonOut.textContent = JSON.stringify(out, null, 2);
}

// Wizard functions
function setStep(n){
  Object.values(stepEls).forEach(el => el.classList.add("hidden"));
  stepEls[n].classList.remove("hidden");

  stepsNav.forEach(s => {
    const sn = Number(s.getAttribute("data-step"));
    s.classList.toggle("active", sn === n);
    s.classList.toggle("done", sn < n);
  });

  if(n === 1){
    leftTitle.textContent = "Stap 1 ‚Äî Basis";
    leftSub.textContent = "Minimale gegevens. Daarna signalen aanvinken.";
  } else if(n === 2){
    leftTitle.textContent = "Stap 2 ‚Äî Probleemgebieden";
    leftSub.textContent = "Vink signalen aan. Taken worden automatisch gemaakt.";
  } else {
    leftTitle.textContent = "Stap 3 ‚Äî Samenvatting";
    leftSub.textContent = "Export/print.";
  }
}

$("#next1").addEventListener("click", ()=> setStep(2));
$("#back2").addEventListener("click", ()=> setStep(1));
$("#next2").addEventListener("click", ()=> setStep(3));
$("#back3").addEventListener("click", ()=> setStep(2));

stepsNav.forEach(el => {
  el.addEventListener("click", ()=> setStep(Number(el.getAttribute("data-step"))));
  el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); el.click(); } });
});

// Tab switching
tabBtns.forEach(btn => {
  btn.addEventListener("click", ()=>{
    const key = btn.getAttribute("data-tab");
    tabBtns.forEach(b => b.classList.toggle("active", b===btn));
    panels.forEach(p => p.classList.toggle("hidden", p.getAttribute("data-panel") !== key));
  });
});

// Section header toggles
$$(".sec-h").forEach(h => {
  // Avoid toggling on headers where we set cursor default? still ok.
  h.addEventListener("click", ()=> toggleSection(h));
  h.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); h.click(); } });
});

// Reveal updates on change
form.addEventListener("change", (e)=>{
  const t = e.target;
  if(t.matches("[data-reveal]")) updateRevealForInput(t);
  renderOutput();
});

// Also update reveals live for selects/inputs with data-reveal (if ever used)
form.addEventListener("input", (e)=>{
  const t = e.target;
  if(t.matches("[data-reveal]")) updateRevealForInput(t);
  renderOutput();
});

// Copy/print/reset
async function copyJson(){
  try{
    await navigator.clipboard.writeText(jsonOut.textContent || "{}");
    alert("JSON gekopieerd.");
  }catch{
    alert("Kopi√´ren niet gelukt (browserbeperking). Selecteer en kopieer handmatig in de JSON-tab.");
  }
}
$("#btnCopy").addEventListener("click", copyJson);
$("#btnFinalCopy").addEventListener("click", copyJson);

$("#btnPrint").addEventListener("click", ()=> window.print());
$("#btnFinalPrint").addEventListener("click", ()=> window.print());

$("#btnReset").addEventListener("click", ()=>{
  if(!confirm("Alles resetten?")) return;
  form.reset();
  window.__ZS_MANUAL_TASKS = [];
  window.__ZS_BCFI_TASKS = [];
  window.__ZS_MED_SCHEMA_FILE = null;
  $("#bcfiTasksHint").textContent = "‚Äî";
  // hide reveals
  $$("[data-reveal]", form).forEach(inp => updateRevealForInput(inp));
  renderOutput();
  setStep(1);
});

// Zorgplan (new window)
function openCarePlan(){
  const out = window.__ZS_OUT || {};
  const patient = out.patient || {};
  const tasks = (out.taken || []).filter(t => t.selected !== false);

  const safe = (x) => escapeHtml(x || "‚Äî");
  const taskHtml = tasks.length
    ? tasks.map(t => `
        <div style="padding:10px;border:1px solid rgba(17,24,39,.12);border-radius:14px;background:#fff;margin-top:8px;">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <b>${safe(t.title)}</b>
            <span style="font-size:12px;color:#6b7280;font-weight:800;">${safe(t.group)}</span>
          </div>
          <div style="margin-top:6px;font-size:12px;color:#374151;line-height:1.35;">
            <div><b>Uitvoerder:</b> ${safe(t.uitvoerder)}</div>
            <div><b>Signaal:</b> ${safe(t.signaal)}</div>
          </div>
        </div>
      `).join("")
    : `<div style="margin-top:10px;color:#6b7280;">Geen taken geselecteerd.</div>`;

  const meds = out.medicatieschema ? `Opgeladen: ${safe(out.medicatieschema.name)}` : "Geen upload";

  const html = `
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zorgplan ‚Äî Zorgstart</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f8fafc;color:#111827}
    .wrap{max-width:920px;margin:0 auto;padding:22px 16px 40px}
    .head{padding:16px;border:1px solid rgba(17,24,39,.12);border-radius:18px;background:linear-gradient(180deg, rgba(17,24,39,.03), rgba(255,255,255,.9))}
    h1{margin:0;font-size:20px;letter-spacing:-.2px}
    .meta{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kv{padding:10px 12px;border:1px solid rgba(17,24,39,.10);border-radius:14px;background:#fff}
    .k{font-size:11px;font-weight:900;color:#6b7280}
    .v{margin-top:4px;font-size:13px;color:#111827}
    .sec{margin-top:12px;padding:14px;border:1px solid rgba(17,24,39,.10);border-radius:18px;background:#fff}
    .sec h2{margin:0 0 8px;font-size:14px}
    .small{font-size:12px;color:#4b5563;line-height:1.45}
    .noprint{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    button{border:1px solid rgba(17,24,39,.12);background:#fff;padding:10px 12px;border-radius:14px;font-weight:900;cursor:pointer}
    button.primary{background:#0b63ce;color:#fff;border-color:rgba(11,99,206,.35)}
    @media print{ .noprint{display:none} body{background:#fff} .wrap{max-width:100%;padding:0} .sec,.kv{break-inside:avoid} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;">
        <h1>Zorgplan ‚Äî Takenoverzicht</h1>
        <div style="font-size:12px;color:#6b7280;font-weight:900;">${new Date().toLocaleString("nl-BE")}</div>
      </div>
      <div class="meta">
        <div class="kv"><div class="k">Pati√´nt</div><div class="v">${safe(patient.naam)}</div></div>
        <div class="kv"><div class="k">Telefoon</div><div class="v">${safe(patient.tel)}</div></div>
        <div class="kv" style="grid-column:1/-1"><div class="k">Adres</div><div class="v">${safe(patient.adres)}</div></div>
        <div class="kv"><div class="k">Huisarts</div><div class="v">${safe(patient.huisarts)}</div></div>
        <div class="kv"><div class="k">Medicatieschema</div><div class="v">${meds}</div></div>
      </div>
    </div>

    <div class="sec">
      <h2>Context</h2>
      <div class="small">${safe(patient.context)}</div>
    </div>

    <div class="sec">
      <h2>Co√∂rdinatie (Nurseline)</h2>
      <div class="small">${out.nurselineCoordGevraagd ? "Ja ‚Äî taak is aangemaakt (zie hieronder)." : "Nee ‚Äî geen co√∂rdinatietaak aangemaakt."}</div>
    </div>

    <div class="sec">
      <h2>Taken</h2>
      ${taskHtml}
    </div>

    <div class="sec">
      <h2>Opmerking</h2>
      <div class="small">${safe(out.opmerking)}</div>
    </div>

    <div class="noprint">
      <button class="primary" onclick="window.print()">Print / PDF</button>
      <button onclick="window.close()">Sluiten</button>
    </div>
  </div>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}
$("#btnCarePlan").addEventListener("click", openCarePlan);

// Init: set reveals correct state, render once
$$("[data-reveal]", form).forEach(inp => updateRevealForInput(inp));
setStep(1);
renderOutput();
</script>
</body>
</html>