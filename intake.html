<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zorgstart ‚Äî Slimme intake (wizard + openklappers + print)</title>
  <meta name="description" content="Slimme, dynamische intake: wizard flow + bijkomende vragen op basis van antwoorden en score. Output: aandachtsgebieden + zorgbundels + samenvatting." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#f6f9fc;
      --panel: rgba(10,47,94,.04);
      --panel2: rgba(10,47,94,.06);
      --border: #d7e2f0;
      --text: #123047;
      --muted: #5b7288;
      --faint: #8899aa;
      --accent: #0b63ce;
      --accent2:#0b63ce;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --r:12px;
      --shadow: 0 8px 20px rgba(10,47,94,0.08);
      --max:1160px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(11,99,206,.10), transparent 55%),
        radial-gradient(900px 600px at 85% 18%, rgba(11,99,206,.08), transparent 60%),
        radial-gradient(800px 560px at 60% 90%, rgba(52,211,153,.10), transparent 55%),
        linear-gradient(180deg,#f6f9fc,#f6f9fc 45%,#f6f9fc);
    }

    /* Print-friendly */
    @media print{
      body{background:#fff;color:#111}
      .topbar,.hero,.btnbar,.navsteps,.right-actions{display:none!important}
      .wrap{max-width:100%; padding:0}
      .grid{grid-template-columns:1fr!important}
      .card{box-shadow:none!important; border:1px solid #ddd!important; background:#fff!important}
      input,select,textarea{background:#fff!important; color:#111!important; border:1px solid #ccc!important}
      .item,.stat,.section{background:#fff!important; border:1px solid #ddd!important}
      pre{white-space:pre-wrap!important; background:#fff!important; color:#111!important; border:1px solid #ddd!important}
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:26px 18px 60px}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(12px);
      background: #ffffff;
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{max-width:var(--max); margin:0 auto; padding:12px 18px; display:flex; align-items:center; gap:14px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .dot{width:11px;height:11px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(11,99,206,.3) 35%, transparent 70%),
                 linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 4px rgba(11,99,206,.12);
    }
    .badge{
      font-size:12px; padding:4px 9px; border-radius:999px;
      background: var(--border);
      border:1px solid var(--border);
      color: var(--muted);
      font-weight:700;
    }
    .spacer{flex:1}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:7px 11px; border-radius:999px;
      background: #f0f5ff;
      border:1px solid var(--border);
      color: var(--muted);
      font-weight:600;
    }

    .hero{
      margin-top:22px;
      background: linear-gradient(180deg, var(--border), #f8fafc);
      border:1px solid var(--border);
      border-radius: calc(var(--r) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::after{
      content:""; position:absolute; inset:-2px;
      background:
        radial-gradient(520px 260px at 18% 0%, rgba(11,99,206,.12), transparent 55%),
        radial-gradient(520px 260px at 82% 0%, rgba(11,99,206,.10), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .hero-inner{position:relative; z-index:1; padding:26px 22px}
    .hero h1{margin:0 0 10px; font-size:26px; letter-spacing:-.2px}
    .lead{margin:0 0 14px; color: var(--muted); line-height:1.45}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: #f0f5ff;
      border:1px solid var(--border);
      color: var(--muted);
      font-size:12px;
      font-weight:700;
    }
    .chip b{color:var(--text)}

    /* Wizard steps */
    .navsteps{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px;
      border-radius: var(--r);
      border:1px solid var(--border);
      background: #ffffff;
      box-shadow: 0 18px 45px rgba(10,47,94,0.06);
    }
    .step{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: #ffffff;
      cursor:pointer;
      user-select:none;
    }
    .step .num{
      width:26px; height:26px; border-radius:10px;
      display:grid; place-items:center;
      font-weight:900;
      border:1px solid var(--border);
      background: #f0f5ff;
      color: var(--muted);
    }
    .step b{font-size:13px}
    .step span{font-size:12px; color:var(--muted); display:block; margin-top:2px}
    .step.active{
      border-color: rgba(11,99,206,.30);
      background: linear-gradient(135deg, rgba(11,99,206,.10), rgba(11,99,206,.06));
    }
    .step.active .num{color:var(--text); border-color: rgba(11,99,206,.30)}
    .step.done .num{
      color: rgba(52,211,153,.95);
      border-color: rgba(52,211,153,.30);
      background: rgba(52,211,153,.10);
    }

    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: #ffffff;
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: 0 18px 45px #ffffff;
      overflow:hidden;
    }
    .card-h{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .card-h h2{margin:0; font-size:14px; letter-spacing:.2px}
    .sub{margin:4px 0 0; color: var(--muted); font-size:12px; line-height:1.35}
    .card-b{padding:16px}

    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 760px){ .form-grid{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color: var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(11,99,206,.45); box-shadow: 0 0 0 4px rgba(11,99,206,.12)}
    .help{color: var(--faint); font-size:12px; margin-top:6px; line-height:1.35}

    .section{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: #f8fafc;
      overflow:hidden;
    }
    .sec-h{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .sec-h .ttl{
      display:flex; gap:10px; align-items:center;
      font-weight:800; letter-spacing:.15px;
      font-size:13px;
    }
    .ico{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background: rgba(11,99,206,.08);
      border:1px solid rgba(11,99,206,.15);
      color: var(--accent);
      font-weight:900;
      font-size:13px;
    }
    .sec-h .meta{color: var(--muted); font-size:12px}
    .sec-b{padding:12px 12px 14px; border-top:1px solid var(--border); display:none}
    .section[data-open="1"] .sec-b{display:block}

    .checks{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 760px){ .checks{grid-template-columns:1fr} }
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: #ffffff;
    }
    .check input{width:auto; margin-top:2px; accent-color: #0b63ce}
    .check b{display:block; font-size:13px}
    .check span{display:block; color: var(--muted); font-size:12px; margin-top:2px; line-height:1.3}

    .reveal{
      margin-top:10px;
      padding:10px 10px;
      border-radius: 14px;
      border:1px dashed var(--border);
      background: #f8fafc;
      display:none;
    }
    .reveal[data-show="1"]{display:block}

    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background: #f0f5ff;
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background: var(--accent); color:#ffffff;
      border-color: rgba(11,99,206,.30);
    }
    .btn:active{transform: translateY(1px)}
    .mini{font-size:12px; color: var(--muted)}
    .right-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .kpi{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: #ffffff;
    }
    .stat .n{font-size:22px; font-weight:900; letter-spacing:-.2px}
    .stat .t{font-size:12px; color: var(--muted); margin-top:2px}
    .list{margin-top:12px; display:flex; flex-direction:column; gap:10px}
    .item{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: #ffffff;
    }
    .item .h{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .tag{
      font-size:11px; font-weight:900;
      padding:5px 9px; border-radius:999px;
      border:1px solid var(--border);
      background: #f0f5ff;
      color: var(--muted);
      white-space:nowrap;
    }
    .tag.good{border-color: rgba(52,211,153,.30); color: rgba(52,211,153,.95); background: rgba(52,211,153,.10)}
    .tag.warn{border-color: rgba(251,191,36,.30); color: rgba(251,191,36,.95); background: rgba(251,191,36,.10)}
    .tag.bad{border-color: rgba(251,113,133,.30); color: rgba(251,113,133,.95); background: rgba(251,113,133,.10)}
    .item p{margin:8px 0 0; color: var(--muted); font-size:12px; line-height:1.4}
    pre{
      margin:12px 0 0;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: #f0f3f8;
      color: #374151;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
    }

    .hidden{display:none!important;}  /* OUTPUT TABS */ .outTabs{   display:flex; gap:8px; flex-wrap:wrap;   margin-top:12px; } .outTab{   appearance:none;   cursor:pointer;   border:1px solid var(--border);   background: #f0f5ff;   color: var(--text);   padding:8px 10px;   border-radius: 999px;   font-weight:800;   font-size:12px; } .outTab.active{   border-color: rgba(11,99,206,.30);   background: linear-gradient(135deg, rgba(11,99,206,.15), rgba(11,99,206,.06)); } .outTab.tech{color: var(--muted)} .outPanel{margin-top:10px}  /* nicer bundle cards */ .bundleCard{   padding:12px;   border-radius: 16px;   border:1px solid var(--border);   background: #ffffff; } .bundleTop{   display:flex; align-items:flex-start; justify-content:space-between; gap:10px; } .bundleName{   font-weight:900;   letter-spacing:.1px; } .bundleWhy{   margin-top:8px;   display:flex; flex-wrap:wrap; gap:8px; } .whyChip{   font-size:12px;   padding:7px 9px;   border-radius:999px;   border:1px solid var(--border);   background: #f0f5ff;   color: var(--muted); } .bundleFoot{   margin-top:10px;   display:flex; justify-content:space-between; align-items:center; gap:10px;   color: var(--muted);   font-size:12px; }  /* TASK BOARD */ .tasksHead{   display:flex; justify-content:space-between; align-items:flex-start; gap:12px;   padding:12px;   border-radius: 16px;   border:1px solid var(--border);   background: #ffffff; } .taskBoard{   margin-top:10px;   display:grid;   grid-template-columns: 1fr;   gap:10px; } .taskGroup{   padding:12px;   border-radius: 16px;   border:1px solid var(--border);   background: #ffffff; } .taskGroupTop{   display:flex; justify-content:space-between; align-items:center; gap:10px; } .taskGroupTitle{font-weight:900} .taskList{   margin-top:10px;   display:flex; flex-direction:column; gap:8px; } .task{   display:flex; gap:10px; align-items:flex-start;   padding:10px;   border-radius: 14px;   border:1px solid var(--border);   background: #f8fafc; } .task .tick{   width:22px; height:22px;   border-radius:8px;   border:1px solid var(--border);   background: rgba(10,47,94,0.06);   display:grid; place-items:center;   color: var(--text);   font-weight:900;   flex:0 0 auto; } .task b{font-size:13px} .task span{display:block; color: var(--muted); font-size:12px; margin-top:2px; line-height:1.3}  /* SUMMARY */ .summaryCard{   padding:12px;   border-radius: 16px;   border:1px solid var(--border);   background: #ffffff; } .summaryRow{   display:grid;   grid-template-columns: 150px 1fr;   gap:10px;   padding:10px 0;   border-bottom:1px solid var(--border); } .summaryRow:last-child{border-bottom:none} .summaryK{color: var(--muted); font-size:12px; font-weight:800} .summaryV{font-size:13px}  /* Zorgplan print view (in nieuw window) */ .zp-wrap{max-width:920px;margin:0 auto;padding:28px 18px 40px;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial} .zp-head{   padding:18px 16px;border-radius:18px;border:1px solid rgba(17,24,39,.12);   background: linear-gradient(180deg, rgba(17,24,39,.03), rgba(17,24,39,.01)); } .zp-title{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap} .zp-title h1{margin:0;font-size:20px;letter-spacing:-.2px;color:#111827} .zp-meta{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px} .zp-kv{padding:10px 12px;border:1px solid rgba(17,24,39,.10);border-radius:14px;background:#fff} .zp-k{font-size:11px;font-weight:800;color:#6b7280} .zp-v{margin-top:4px;font-size:13px;color:#111827} .zp-chiprow{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap} .zp-chip{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid rgba(17,24,39,.12);background:#fff;color:#374151;font-weight:700} .zp-section{margin-top:14px;padding:14px 14px;border-radius:18px;border:1px solid rgba(17,24,39,.10);background:#fff} .zp-section h2{margin:0 0 8px;font-size:14px;color:#111827} .zp-section p{margin:0;color:#4b5563;font-size:12px;line-height:1.45} .zp-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px} .zp-card{padding:12px;border-radius:16px;border:1px solid rgba(17,24,39,.10);background:#fff} .zp-cardtop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start} .zp-cardtop b{color:#111827} .zp-tag{font-size:11px;font-weight:900;padding:5px 9px;border-radius:999px;border:1px solid rgba(17,24,39,.12);background:#f9fafb;color:#374151;white-space:nowrap} .zp-tasklist{margin-top:10px;display:flex;flex-direction:column;gap:8px} .zp-task{padding:10px;border-radius:14px;border:1px solid rgba(17,24,39,.10);background:#fcfcfd} .zp-taskline{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap} .zp-taskline b{color:#111827;font-size:13px} .zp-tasksmall{margin-top:4px;color:#4b5563;font-size:12px;line-height:1.4} .zp-pillrow{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap} .zp-pill{font-size:12px;padding:6px 9px;border-radius:999px;border:1px solid rgba(17,24,39,.12);background:#fff;color:#374151;font-weight:700} .zp-footer{margin-top:12px;color:#6b7280;font-size:11px} @media print{   .zp-noprint{display:none!important}   body{background:#fff}   .zp-wrap{max-width:100%;padding:0}   .zp-section,.zp-card,.zp-kv{break-inside:avoid} }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot"></span>
            <a href="index.html" style="text-decoration:none;color:inherit">Zorgstart</a>
        <span class="badge">Slimme intake</span>
      </div>
      <div class="spacer"></div>
      <span class="pill">Wizard ‚Ä¢ Openklappers ‚Ä¢ Print/PDF</span>
    </div>
  </div>

  <div class="wrap">
    <section class="hero">
      <div class="hero-inner">
        <h1>Veilig-thuis gesprek ‚Äî in 3 stappen</h1>
        <p class="lead">
          Progressieve vragenlijst: alleen relevante vervolgvragen verschijnen. Output: <b>aandachtsgebieden</b> + <b>zorgbundels</b> +
          samenvatting voor matching/registratie.
        </p>
        <div class="row">
          <span class="chip"><b>Stap 1</b> Basis</span>
          <span class="chip"><b>Stap 2</b> Aandachtsgebieden</span>
          <span class="chip"><b>Stap 3</b> Samenvatting</span>
        </div>
      </div>
    </section>

    <!-- Wizard navigation -->
    <div class="navsteps" id="navSteps">
      <div class="step active" data-step="1" role="button" tabindex="0">
        <div class="num">1</div>
        <div><b>Basis</b><span>identiteit & context</span></div>
      </div>
      <div class="step" data-step="2" role="button" tabindex="0">
        <div class="num">2</div>
        <div><b>Aandachtsgebieden</b><span>kwetsbaarheidsscore</span></div>
      </div>
      <div class="step" data-step="3" role="button" tabindex="0">
        <div class="num">3</div>
        <div><b>Samenvatting</b><span>bundels & export</span></div>
      </div>

      <div class="spacer"></div>
      <div class="right-actions">
        <button class="btn" type="button" id="btnPrint">Print/PDF</button>
        <button class="btn" type="button" id="btnCopy">Kopieer JSON</button>
        <button class="btn primary" type="button" id="btnCarePlan">Zorgplan (PDF)</button>         <button class="btn" type="button" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: FORM/WIZARD -->
      <section class="card">
        <div class="card-h">
          <div>
            <h2 id="leftTitle">Stap 1 ‚Äî Basis</h2>
            <p class="sub" id="leftSub">Vul minimale gegevens in. Daarna ga je naar aandachtsgebieden.</p>
          </div>
          <span class="badge" id="statusBadge">Start</span>
        </div>

        <div class="card-b">
          <form id="zsForm" autocomplete="on">
            <!-- STEP 1 -->
            <div id="step1">
              <div class="form-grid">
                <div>
                  <label>Naam</label>
                  <input name="naam" placeholder="Voornaam + naam" />
                </div>
                <div>
                  <label>Rijksregisternummer</label>
                  <input name="rrn" placeholder="xx.xx.xx-xxx.xx" />
                </div>
                <div>
                  <label>Telefoon</label>
                  <input name="tel" placeholder="+32..." />
                </div>
                <div>
                  <label>Mutualiteit</label>
                  <input name="mut" placeholder="bv. CM, Solidaris..." />
                </div>
                <div style="grid-column:1/-1">
                  <label>Adres</label>
                  <input name="adres" placeholder="Straat + nr, postcode, gemeente" />
                </div>
                <div>
                  <label>Huisarts</label>
                  <input name="huisarts" placeholder="Naam arts (optioneel)" />
                </div>
                <div>
                  <label>Mantelzorg / contactpersoon</label>
                  <input name="mantel" placeholder="Naam + telefoon (optioneel)" />
                </div>
              </div>

              <div class="btnbar">
                <button type="button" class="btn primary" id="next1">Naar Aandachtsgebieden</button>
              </div>
              <div class="help">Tip: je kan later validatie toevoegen (RRN/telefoon) zodra dit aan backend gekoppeld wordt.</div>
            </div>

            <!-- STEP 2 -->
            <div id="step2" class="hidden">
              <div class="mini">Klik op een aandachtsgebied om open te klappen. Bijkomende vragen verschijnen automatisch.</div>

              <!-- COGNITIE -->
              <div class="section" data-open="1" data-section="cognitie">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üß†</span> Cognitie & ori√´ntatie</div>
                  <div class="meta" id="meta-cognitie">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="cog_desorient" data-pb="Cognitie" data-score="2" data-reveal="#rev-cog-details" />
                      <div><b>Desori√´ntatie</b><span>tijd/plaats/personen; wisselend bewustzijn</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="cog_dementie" data-pb="Cognitie" data-score="2" data-reveal="#rev-cog-details" />
                      <div><b>Dementie-syndroom gekend</b><span>diagnose of duidelijke signalen</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="cog_delir" data-pb="Cognitie" data-score="3" data-reveal="#rev-cog-details" />
                      <div><b>Delirium recent</b><span>tijdens opname of recent thuis</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="cog_medicatievergeet" data-pb="Medicatie" data-score="2" data-reveal="#rev-medicatie-adherentie" />
                      <div><b>Medicatie wordt vergeten</b><span>therapietrouw onzeker</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-cog-details">
                    <div class="form-grid">
                      <div>
                        <label>Is er toezicht in huis?</label>
                        <select name="cog_toezicht">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja, permanent</option>
                          <option>Ja, gedeeltelijk</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Risico op verdwalen/veiligheid?</label>
                        <select name="cog_veilig">
                          <option value="">Kies‚Ä¶</option>
                          <option>Laag</option>
                          <option>Middel</option>
                          <option>Hoog</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                    <div class="help">Deze antwoorden sturen ‚Äúveiligheid thuis‚Äù en ‚Äúmedicatiebegeleiding‚Äù aan.</div>
                  </div>

                  <div class="reveal" id="rev-medicatie-adherentie">
                    <div class="form-grid">
                      <div>
                        <label>Kan pati√´nt zelf medicatie beheren?</label>
                        <select name="med_self">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja, zelfstandig</option>
                          <option>Gedeeltelijk (hulp nodig)</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Risico op verwarring/verwisseling?</label>
                        <select name="med_confusion">
                          <option value="">Kies‚Ä¶</option>
                          <option>Laag</option>
                          <option>Middel</option>
                          <option>Hoog</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Score-based reveal (alleen tonen als Cognitie-score >= 4) -->
                  <div class="reveal" id="rev-cog-score4" data-show="0">
                    <label>Extra: heeft pati√´nt nood aan dagelijks contactmoment?</label>
                    <select name="cog_dailycheck">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>Onbekend</option>
                    </select>
                    <div class="help">Verschijnt enkel wanneer Cognitie-score hoog genoeg is (drempel).</div>
                  </div>

                </div>
              </div>

              <!-- MOBILITEIT -->
              <div class="section" data-open="0" data-section="mobiliteit">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üö∂</span> Mobiliteit & valrisico</div>
                  <div class="meta" id="meta-mobiliteit">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="mob_stappen" data-pb="Mobiliteit" data-score="2" data-reveal="#rev-mob-hulpmiddel" />
                      <div><b>Moeilijk stappen</b><span>instabiel, beperkte afstand</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="mob_transfers" data-pb="Mobiliteit" data-score="2" data-reveal="#rev-mob-transfers" />
                      <div><b>Transfers moeilijk</b><span>bed/stoel/toilet</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="mob_val" data-pb="Valrisico" data-score="3" data-reveal="#rev-val-details" />
                      <div><b>Val in laatste 12 maanden</b><span>of bijna-val met letsel</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="mob_trap" data-pb="Woonomgeving" data-score="1" data-reveal="#rev-woning-trap" />
                      <div><b>Trappen in woning</b><span>zonder lift / uitdagende toegang</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-mob-hulpmiddel">
                    <label>Is een hulpmiddel nodig?</label>
                    <select name="mob_hulpmiddel">
                      <option value="">Kies‚Ä¶</option>
                      <option>Geen</option>
                      <option>Stok</option>
                      <option>Rollator</option>
                      <option>Rolstoel</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <div class="reveal" id="rev-mob-transfers">
                    <div class="form-grid">
                      <div>
                        <label>Transfers: hulp van persoon nodig?</label>
                        <select name="transfer_hulp">
                          <option value="">Kies‚Ä¶</option>
                          <option>Nee</option>
                          <option>Ja, 1 persoon</option>
                          <option>Ja, 2 personen / tillift</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Tillift of glijhulpmiddel aanwezig?</label>
                        <select name="transfer_tools">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Te voorzien</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-val-details">
                    <div class="form-grid">
                      <div>
                        <label>Aantal vallen</label>
                        <select name="val_aantal">
                          <option value="">Kies‚Ä¶</option>
                          <option>1</option>
                          <option>2</option>
                          <option>3 of meer</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Letsel na val?</label>
                        <select name="val_letsel">
                          <option value="">Kies‚Ä¶</option>
                          <option>Nee</option>
                          <option>Ja, licht</option>
                          <option>Ja, ernstig</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-woning-trap">
                    <div class="form-grid">
                      <div>
                        <label>Trap naar slaapkamer/badkamer?</label>
                        <select name="trap_kritisch">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Leuning / veilige toegang?</label>
                        <select name="trap_veilig">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Score-based reveal (alleen tonen als Valrisico-score >= 3) -->
                  <div class="reveal" id="rev-val-score3" data-show="0">
                    <label>Extra: Personenalarm automatisch voorstellen?</label>
                    <select name="val_alarm_suggest">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>reeds in orde</option>
                      <option>Onbekend</option>
                    </select>
                    <div class="help">Verschijnt enkel wanneer Valrisico-score hoog genoeg is.</div>
                  </div>
                </div>
              </div>

              <!-- MEDICATIE -->
              <div class="section" data-open="0" data-section="medicatie">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üíä</span> Medicatie & polyfarmacie</div>
                  <div class="meta" id="meta-medicatie">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="form-grid">
                    <div>
                      <label>Aantal medicaties</label>
                      <input type="number" name="med_aantal" min="0" placeholder="bv. 7" />
                      <div class="help">Vanaf >5 wordt polyfarmacie-score automatisch toegevoegd.</div>
                    </div>
                    <div>
                      <label>Complex schema?</label>
                      <select name="med_complex">
                        <option value="">Kies‚Ä¶</option>
                        <option>Nee</option>
                        <option>Ja, meerdere innamemomenten</option>
                        <option>Ja, injecties/insuline</option>
                        <option>Onbekend</option>
                      </select>
                    </div>
                  </div>

                  <div class="checks" style="margin-top:10px;">
                    <label class="check">
                      <input type="checkbox" name="med_anticoag" data-pb="Medicatie" data-score="2" data-reveal="#rev-med-anticoag" />
                      <div><b>Anticoagulatie</b><span>NOAC/Marcoumar‚Ä¶</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_inject" data-pb="Technische zorg" data-score="2" data-reveal="#rev-med-inject" />
                      <div><b>Injecties nodig</b><span>insuline of andere SC/IM</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_baxter" data-pb="Medicatie" data-score="1" />
                      <div><b>Baxter/medicatierol</b><span>of weekbox georganiseerd</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="med_overzicht" data-pb="Medicatie" data-score="1" data-reveal="#rev-med-schema" />
                      <div><b>Schema ontbreekt</b><span>actueel medicatieschema niet beschikbaar</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-med-anticoag">
                    <div class="form-grid">
                      <div>
                        <label>Type</label>
                        <select name="anticoag_type">
                          <option value="">Kies‚Ä¶</option>
                          <option>NOAC</option>
                          <option>Vitamine K antagonist</option>
                          <option>LMWH</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Opvolging geregeld?</label>
                        <select name="anticoag_follow">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-med-inject">
                    <div class="form-grid">
                      <div>
                        <label>Frequentie</label>
                        <select name="inject_freq">
                          <option value="">Kies‚Ä¶</option>
                          <option>Dagelijks</option>
                          <option>Meerdere keren per dag</option>
                          <option>Wekelijks</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Kan pati√´nt zelf injecteren?</label>
                        <select name="inject_self">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-med-schema">
                    <label>Wie kan actueel schema bezorgen?</label>
                    <select name="schema_bron">
                      <option value="">Kies‚Ä¶</option>
                      <option>Huisarts</option>
                      <option>Apotheek</option>
                      <option>Ziekenhuis / ontslagbrief</option>
                      <option>Mantelzorger</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <!-- Score-based reveal: als med_aantal >= 10 -->
                  <div class="reveal" id="rev-med-10" data-show="0">
                    <label>Extra: voorstel voor medicatiereview (huisarts/apotheek)?</label>
                    <select name="med_review">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>Onbekend</option>
                    </select>
                    <div class="help">Verschijnt wanneer medicaties ‚â• 10 (prototype-drempel).</div>
                  </div>
                </div>
              </div>

              <!-- TECHNISCH -->
              <div class="section" data-open="0" data-section="technisch">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">ü©∫</span> Wondzorg & technische zorg</div>
                  <div class="meta" id="meta-technisch">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="tech_wonde" data-pb="Wondzorg" data-score="2" data-reveal="#rev-wonde-details" />
                      <div><b>Postoperatieve / acute wonde</b><span>verband, controle, opvolging</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="tech_decub" data-pb="Wondzorg" data-score="3" data-reveal="#rev-decub" />
                      <div><b>Decubitus</b><span>risico of aanwezig</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="tech_katheter" data-pb="Technische zorg" data-score="2" data-reveal="#rev-katheter" />
                      <div><b>Katheter / urostoma</b><span>zorg en opvolging</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="tech_stoma" data-pb="Technische zorg" data-score="2" data-reveal="#rev-stoma" />
                      <div><b>Stoma</b><span>educatie / materiaalbeheer</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-wonde-details">
                    <div class="form-grid">
                      <div>
                        <label>Type wonde</label>
                        <select name="wonde_type">
                          <option value="">Kies‚Ä¶</option>
                          <option>Postoperatief</option>
                          <option>Trauma</option>
                          <option>Ulcus</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Frequentie verbandwissel</label>
                        <select name="wonde_freq">
                          <option value="">Kies‚Ä¶</option>
                          <option>Dagelijks</option>
                          <option>Om de 2 dagen</option>
                          <option>2‚Äì3x/week</option>
                          <option>Wekelijks</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-decub">
                    <div class="form-grid">
                      <div>
                        <label>Decubitus stadium</label>
                        <select name="decub_stage">
                          <option value="">Kies‚Ä¶</option>
                          <option>Risico (geen wonde)</option>
                          <option>Stadium 1</option>
                          <option>Stadium 2</option>
                          <option>Stadium 3-4</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Antidecubitus matras aanwezig?</label>
                        <select name="decub_matras">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Te voorzien</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-katheter">
                    <div class="form-grid">
                      <div>
                        <label>Type</label>
                        <select name="katheter_type">
                          <option value="">Kies‚Ä¶</option>
                          <option>Blaaskatheter</option>
                          <option>Suprapubische katheter</option>
                          <option>Condoomkatheter</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Problemen (lekken/pijn/koorts)?</label>
                        <select name="katheter_prob">
                          <option value="">Kies‚Ä¶</option>
                          <option>Nee</option>
                          <option>Ja</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-stoma">
                    <label>Is stoma-educatie gewenst?</label>
                    <select name="stoma_educ">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>Onbekend</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- SOCIAAL -->
              <div class="section" data-open="0" data-section="sociaal">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üè†</span> Wooncontext & kwetsbaarheid</div>
                  <div class="meta" id="meta-sociaal">‚Äî</div>
                </div>
                <div class="sec-b">
                  <div class="checks">
                    <label class="check">
                      <input type="checkbox" name="soc_alleen" data-pb="Wooncontext" data-score="3" data-reveal="#rev-alleen" />
                      <div><b>Alleenwonend</b><span>of geen steun mogelijk in huis</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_mantel_overlast" data-pb="Mantelzorg" data-score="2" data-reveal="#rev-mantel" />
                      <div><b>Mantelzorger overbelast</b><span>draagkracht laag / conflict</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_fin" data-pb="Financieel" data-score="2" />
                      <div><b>Financi√´le problemen</b><span>zorgkosten, administratie</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_taal" data-pb="Communicatie" data-score="1" data-reveal="#rev-taal" />
                      <div><b>Taal/gezondheidsgeletterdheid</b><span>extra ondersteuning</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_psych" data-pb="Psychisch" data-score="2" data-reveal="#rev-psych" />
                      <div><b>Psychische kwetsbaarheid</b><span>angst/depressie/verslaving</span></div>
                    </label>
                    <label class="check">
                      <input type="checkbox" name="soc_alarm" data-pb="Veiligheid" data-score="2" data-reveal="#rev-alarm" />
                      <div><b>Personenalarm wenselijk</b><span>valrisico, alleen, onzekerheid</span></div>
                    </label>
                  </div>

                  <div class="reveal" id="rev-alleen">
                    <div class="form-grid">
                      <div>
                        <label>Is er dagelijks contact mogelijk?</label>
                        <select name="alleen_contact">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                      <div>
                        <label>Toegang veilig (sleutel/kluis)?</label>
                        <select name="toegang">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-mantel">
                    <label>Hoofdreden belasting</label>
                    <select name="mantel_reason">
                      <option value="">Kies‚Ä¶</option>
                      <option>Tijd/overname zorgtaken</option>
                      <option>Emotioneel</option>
                      <option>Conflicten/afstemming</option>
                      <option>Eigen gezondheid mantelzorger</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <div class="reveal" id="rev-taal">
                    <div class="form-grid">
                      <div>
                        <label>Voorkeurstaal</label>
                        <input name="taal" placeholder="bv. NL/FR/EN/..." />
                      </div>
                      <div>
                        <label>Tolk / ondersteuning nodig?</label>
                        <select name="tolk">
                          <option value="">Kies‚Ä¶</option>
                          <option>Ja</option>
                          <option>Nee</option>
                          <option>Onbekend</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="reveal" id="rev-psych">
                    <label>Welke signalen?</label>
                    <select name="psych_type">
                      <option value="">Kies‚Ä¶</option>
                      <option>Angst</option>
                      <option>Depressie</option>
                      <option>Verslaving</option>
                      <option>Sociaal isolement</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <div class="reveal" id="rev-alarm">
                    <label>Alarm reeds aanwezig?</label>
                    <select name="alarm_status">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>Te voorzien</option>
                      <option>Onbekend</option>
                    </select>
                  </div>

                  <!-- Score-based reveal: als (Wooncontext+Valrisico) hoog -->
                  <div class="reveal" id="rev-netwerk-high" data-show="0">
                    <label>Extra: nood aan actieve co√∂rdinatie (case manager / zorgco√∂rdinator)?</label>
                    <select name="coord_need">
                      <option value="">Kies‚Ä¶</option>
                      <option>Ja</option>
                      <option>Nee</option>
                      <option>Onbekend</option>
                    </select>
                    <div class="help">Verschijnt bij combinatie ‚Äúalleen + valrisico‚Äù of hoge contextscore.</div>
                  </div>
                </div>
              </div>

              <!-- OPM -->
              <div class="section" data-open="0" data-section="opm">
                <div class="sec-h" role="button" tabindex="0">
                  <div class="ttl"><span class="ico">üìù</span> Aanvullende info</div>
                  <div class="meta" id="meta-opm">‚Äî</div>
                </div>
                <div class="sec-b">
                  <label>Vrije opmerkingen (kort)</label>
                  <textarea name="opm" placeholder="Wat moeten we zeker weten? (bv. ontslagdatum, materiaal besteld, huisarts bereikt, ...)"></textarea>
                </div>
              </div>

              <div class="btnbar">
                <button type="button" class="btn" id="back2">Terug</button>
                <button type="button" class="btn primary" id="next2">Naar samenvatting</button>
              </div>
              <div class="help">Je hoeft niets ‚Äúte genereren‚Äù: rechts wordt live bijgewerkt.</div>
            </div>

            <!-- STEP 3 -->
            <div id="step3" class="hidden">
              <div class="mini">Controleer de output. Kopieer JSON of print als PDF.</div>
              <div class="btnbar">
                <button type="button" class="btn" id="back3">Terug</button>
                <button type="button" class="btn primary" id="btnFinalCopy">Kopieer JSON</button>
                <button type="button" class="btn" id="btnFinalPrint">Print/PDF</button>
              </div>
              <div class="help">Stap 3 is bewust ‚Äúread-only‚Äù: de inhoud komt uit stap 1‚Äì2.</div>
            </div>
          </form>
        </div>
      </section>

      <!-- RIGHT: OUTPUT -->
      <aside class="card">
        <div class="card-h">
          <div>
            <h2>Output (live)</h2>
            <p class="sub">Aandachtsgebieden + zorgbundels + JSON (later 1-op-1 door te sturen naar Zorgstart/EPD).</p>
          </div>
          <span class="badge" id="severityBadge">‚Äî</span>
        </div>

        <div class="card-b">
          <div class="kpi">
            <div class="stat">
              <div class="n" id="scoreTotal">0</div>
              <div class="t">Kwetsbaarheidsscore (prototype)</div>
            </div>
            <div class="stat">
              <div class="n" id="pbCount">0</div>
              <div class="t">Geactiveerde probleemgebieden</div>
            </div>
          </div>

          <!-- OUTPUT TABS -->
        <div class="outTabs">
          <button class="outTab active" type="button" data-tab="bundels">Zorgbundels</button>
          <button class="outTab" type="button" data-tab="taken">Taken</button>
          <button class="outTab" type="button" data-tab="samenvatting">Samenvatting</button>
          <button class="outTab tech" type="button" data-tab="json">Technisch (JSON)</button>
        </div>

        <!-- TAB: BUNDELS -->
        <div class="outPanel" data-panel="bundels">
          <div class="list" id="bundleList"></div>
        </div>

        <!-- TAB: TAKEN -->
        <div class="outPanel hidden" data-panel="taken">
          <<div class="tasksHead">
  <div>
    <b>Concreet takenpakket</b>
    <div class="mini">Automatisch afgeleid uit aandachtsgebieden & zorgbundels (prototype-regels) + manuele aanpassingen.</div>
  </div>

  <div class="tasksMeta" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
    <span class="pill" id="taskCountPill">0 taken</span>
    <button class="btn" type="button" id="btnAddTask">+ Taak toevoegen</button>
  </div>
</div>
          <div id="taskBoard" class="taskBoard"></div>
        </div>

        <!-- TAB: SAMENVATTING -->
        <div class="outPanel hidden" data-panel="samenvatting">
          <div class="summaryCard" id="summaryCard">
            <div class="summaryRow">
              <div class="summaryK">Pati√´nt</div>
              <div class="summaryV" id="sumPatient">‚Äî</div>
            </div>
            <div class="summaryRow">
              <div class="summaryK">Top-probleemgebieden</div>
              <div class="summaryV" id="sumPB">‚Äî</div>
            </div>
            <div class="summaryRow">
              <div class="summaryK">Aanpak</div>
              <div class="summaryV" id="sumApproach">‚Äî</div>
            </div>
            <div class="summaryRow">
              <div class="summaryK">Opmerking</div>
              <div class="summaryV" id="sumNote">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- TAB: JSON (optie) -->
        <div class="outPanel hidden" data-panel="json">
          <pre id="jsonOut">{}</pre>
        </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ===========================
   Zorgstart Slimme Intake (V1 prototype)
   - Wizard (3 stappen)
   - Openklappers (checkbox -> reveal)
   - Score-based reveals (drempels)
   - Live output (bundels + JSON)
   - Print/PDF
   =========================== */

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

const form = $("#zsForm");
const statusBadge = $("#statusBadge");
const severityBadge = $("#severityBadge");
const scoreTotalEl = $("#scoreTotal");
const pbCountEl = $("#pbCount");
const bundleList = $("#bundleList");
const jsonOut = $("#jsonOut");

const leftTitle = $("#leftTitle");
const leftSub = $("#leftSub");

const stepEls = {
  1: $("#step1"),
  2: $("#step2"),
  3: $("#step3")
};

const stepsNav = $$(".step", $("#navSteps"));

const PB = {
  Cognitie:{label:"Cognitie & ori√´ntatie"},
  Mobiliteit:{label:"Mobiliteit"},
  Valrisico:{label:"Valrisico"},
  Medicatie:{label:"Medicatie & polyfarmacie"},
  Wondzorg:{label:"Wondzorg"},
  "Technische zorg":{label:"Technische zorg"},
  Woonomgeving:{label:"Woonomgeving"},
  Wooncontext:{label:"Wooncontext"},
  Mantelzorg:{label:"Mantelzorgbelasting"},
  Financieel:{label:"Financi√´le kwetsbaarheid"},
  Communicatie:{label:"Taal/gezondheidsgeletterdheid"},
  Psychisch:{label:"Psychisch welzijn"},
  Veiligheid:{label:"Veiligheid thuis"}
};

function severityTag(score){
  if(score >= 10) return {cls:"bad", txt:"hoog"};
  if(score >= 6)  return {cls:"warn", txt:"matig"};
  return {cls:"good", txt:"laag"};
}

function toggleSection(headerEl){
  const sec = headerEl.closest(".section");
  const open = sec.getAttribute("data-open") === "1";
  sec.setAttribute("data-open", open ? "0" : "1");
}

function updateRevealForInput(inp){
  const sel = inp.getAttribute("data-reveal");
  if(!sel) return;
  const rev = $(sel);
  if(!rev) return;
  const show = (inp.type === "checkbox") ? inp.checked : !!inp.value;
  rev.setAttribute("data-show", show ? "1" : "0");
}

function updateMeta(){
  const sections = $$(".section");
  sections.forEach(sec => {
    const id = sec.getAttribute("data-section");
    const meta = $("#meta-" + id);
    if(!meta) return;
    const checks = $$("input[type=checkbox]", sec);
    const checked = checks.filter(c => c.checked).length;
    meta.textContent = checked ? `${checked} signal(en)` : "‚Äî";
  });
}

function collectData(){
  const data = {};
  const fd = new FormData(form);
  for(const [k,v] of fd.entries()){
    if(v !== "") data[k] = v;
  }
  $$("input[type=checkbox]", form).forEach(c => data[c.name] = !!c.checked);
  return data;
}

function computePB(){
  const pbScores = {};
  let total = 0;

  $$("input[type=checkbox][data-pb]", form).forEach(c => {
    if(!c.checked) return;
    const pb = c.getAttribute("data-pb");
    const s  = Number(c.getAttribute("data-score") || "1");
    pbScores[pb] = (pbScores[pb] || 0) + s;
    total += s;
  });

  // Medicatie count rule (polyfarmacie)
  const medAantal = Number($("input[name=med_aantal]")?.value || "0");
  if(medAantal > 5){ pbScores["Medicatie"] = (pbScores["Medicatie"] || 0) + 2; total += 2; }

  // Complex schema adds
  const medComplex = ($("select[name=med_complex]")?.value || "");
  if(medComplex.includes("Ja")){ pbScores["Medicatie"] = (pbScores["Medicatie"] || 0) + 1; total += 1; }

  // Safety amplification: alone + falls
  const alleen = $("input[name=soc_alleen]")?.checked;
  const val    = $("input[name=mob_val]")?.checked;
  if(alleen && val){
    pbScores["Veiligheid"] = (pbScores["Veiligheid"] || 0) + 2;
    total += 2;
  }

  return {pbScores, total, medAantal};
}

function suggestBundles(pbScores, data, medAantal){
  const bundles = [];
  const has = (k, min=1) => (pbScores[k] || 0) >= min;

  // 1) Medicatiebegeleiding
  const medRisk = has("Medicatie",2) || medAantal > 5 || (data.med_confusion === "Hoog") || data.cog_medicatievergeet;
  if(medRisk){
    bundles.push({
      name:"Zorgbundel: Medicatiebegeleiding",
      why:[
        medAantal > 5 ? "Polyfarmacie (>5 medicaties)" : null,
        data.med_complex ? `Schema: ${data.med_complex}` : null,
        data.med_confusion ? `Verwarringsrisico: ${data.med_confusion}` : null,
        data.cog_medicatievergeet ? "Therapietrouw onzeker" : null
      ].filter(Boolean),
      prio: (medAantal >= 10 || data.med_confusion==="Hoog") ? "hoog" : "matig"
    });
  }

  // 2) Mobiliteit/Valpreventie
  if(has("Valrisico",2) || has("Mobiliteit",2)){
    bundles.push({
      name:"Zorgbundel: Mobiliteit & valpreventie",
      why:[
        data.mob_val ? "Valincident(en) gemeld" : null,
        data.mob_stappen ? "Stapproblemen" : null,
        data.mob_transfers ? "Transfers moeilijk" : null,
        data.mob_hulpmiddel ? `Hulpmiddel: ${data.mob_hulpmiddel}` : null
      ].filter(Boolean),
      prio: (data.mob_val && data.soc_alleen) ? "hoog" : "matig"
    });
  }

  // 3) Technische thuisverpleging / Wondzorg
  if(has("Wondzorg",2) || has("Technische zorg",2)){
    bundles.push({
      name:"Zorgbundel: Technische thuisverpleging",
      why:[
        data.tech_wonde ? `Wonde: ${data.wonde_type || "onbekend"} (${data.wonde_freq || "freq onbekend"})` : null,
        data.tech_decub ? `Decubitus: ${data.decub_stage || "onbekend"} (matras: ${data.decub_matras || "onbekend"})` : null,
        data.tech_katheter ? `Katheter: ${data.katheter_type || "onbekend"}` : null,
        data.tech_stoma ? `Stoma: educatie ${data.stoma_educ || "onbekend"}` : null,
        data.med_inject ? `Injecties: ${data.inject_freq || "freq onbekend"} (zelf: ${data.inject_self || "onbekend"})` : null
      ].filter(Boolean),
      prio: (data.tech_decub && (data.decub_stage||"").includes("3")) ? "hoog" : "matig"
    });
  }

  // 4) Veiligheid thuis
  const safety = has("Veiligheid",2) || data.soc_alarm || (data.soc_alleen && data.mob_val) || (data.cog_veilig === "Hoog");
  if(safety){
    bundles.push({
      name:"Zorgbundel: Veiligheid thuis",
      why:[
        data.soc_alarm ? `Personenalarm: ${data.alarm_status || "onbekend"}` : null,
        (data.soc_alleen && data.mob_val) ? "Alleenwonend + valrisico (prioriteit)" : null,
        data.cog_veilig === "Hoog" ? "Cognitieve veiligheidsrisico‚Äôs (hoog)" : null
      ].filter(Boolean),
      prio: (data.soc_alleen && data.mob_val) || (data.cog_veilig === "Hoog") ? "hoog" : "matig"
    });
  }

  // 5) Co√∂rdinatie & netwerk
  if(has("Wooncontext",2) || has("Mantelzorg",2) || has("Communicatie",1) || has("Financieel",1) || data.coord_need==="Ja"){
    bundles.push({
      name:"Zorgbundel: Co√∂rdinatie & netwerkondersteuning",
      why:[
        data.soc_alleen ? `Alleenwonend (contact: ${data.alleen_contact || "onbekend"})` : null,
        data.soc_mantel_overlast ? `Mantelzorger overbelast (${data.mantel_reason || "reden onbekend"})` : null,
        data.soc_taal ? `Communicatie: taal ${data.taal || "onbekend"}, tolk ${data.tolk || "onbekend"}` : null,
        data.soc_fin ? "Financi√´le kwetsbaarheid" : null,
        data.coord_need==="Ja" ? "Actieve co√∂rdinatie gevraagd" : null
      ].filter(Boolean),
      prio: (data.soc_alleen && data.soc_mantel_overlast) ? "hoog" : "matig"
    });
  }

  if(!bundles.length){
    bundles.push({name:"Geen bundel (nog) ‚Äî minimale opvolging", why:["Onvoldoende signalen om een bundel te activeren."], prio:"laag"});
  }
  return bundles;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

function setScoreBasedReveals(pbScores, medAantal){
  // 1) Cognitie-score >= 4 => toon extra (rev-cog-score4)
  const cogScore = pbScores["Cognitie"] || 0;
  $("#rev-cog-score4")?.setAttribute("data-show", (cogScore >= 4) ? "1" : "0");

  // 2) Valrisico-score >= 3 => toon extra (rev-val-score3)
  const valScore = pbScores["Valrisico"] || 0;
  $("#rev-val-score3")?.setAttribute("data-show", (valScore >= 3) ? "1" : "0");

  // 3) Medicaties >= 10 => toon extra (rev-med-10)
  $("#rev-med-10")?.setAttribute("data-show", (medAantal >= 10) ? "1" : "0");

  // 4) (Alleen + valrisico) => toon netwerk-high
  const alone = $("input[name=soc_alleen]")?.checked;
  const fall  = $("input[name=mob_val]")?.checked;
  $("#rev-netwerk-high")?.setAttribute("data-show", (alone && fall) ? "1" : "0");
}

// Tabs
const tabBtns = $$(".outTab");
const panels = $$(".outPanel");

tabBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const key = btn.getAttribute("data-tab");
    tabBtns.forEach(b=> b.classList.toggle("active", b===btn));
    panels.forEach(p=> p.classList.toggle("hidden", p.getAttribute("data-panel") !== key));
  });
});


  // Task templates (prototype)
function buildTasks(pbScores, data, bundles){
  const DEFAULT_COORD = "Zorgstart-co√∂rdinatie";

  // Helper om taken 1√ó te houden en triggers te verzamelen
  const byId = new Map();

  const add = ({
    id,
    group,
    title,
    detail,
    uitvoerder,
    when = "Binnen 24u",
    coord = DEFAULT_COORD,
    triggers = []
  }) => {
    if(!id) throw new Error("Task id ontbreekt");
    const existing = byId.get(id);
    if(existing){
      // merge triggers, keep earliest timing if you want; for demo: keep existing fields
      const set = new Set([...(existing.triggers||[]), ...triggers]);
      existing.triggers = Array.from(set);
      return;
    }
    byId.set(id, {
      id, group, title, detail,
      uitvoerder: uitvoerder || "‚Äî",
      when, coord,
      triggers: Array.from(new Set(triggers)),
      selected: true
    });
  };

  const hasBundle = (txt) => bundles.some(b => (b.name||"").includes(txt));
  const trig = (...arr) => arr.filter(Boolean);

  // -------- Medicatiebegeleiding --------
  if(hasBundle("Medicatiebegeleiding")){
    add({
      id:"MED_SCHEMA",
      group:"Medicatiebegeleiding",
      title:"Medicatieschema opvragen/valideren",
      detail:"Vraag actueel schema op (huisarts/apotheek/ontslagbrief) en bevestig laatste wijzigingen.",
      uitvoerder:"Apotheker / huisarts",
      when:"Vandaag",
      triggers: trig(
        "Zorgbundel: Medicatiebegeleiding",
        (pbScores["Medicatie"] ? "Probleemgebied: Medicatie" : null),
        (data.cog_medicatievergeet ? "Signaal: therapietrouw onzeker" : null),
        (Number(data.med_aantal||0) > 5 ? "Signaal: polyfarmacie" : null),
        (data.med_overzicht ? "Signaal: schema ontbreekt" : null)
      )
    });

    add({
      id:"MED_STRUCT",
      group:"Medicatiebegeleiding",
      title:"Innamemomenten structureren",
      detail:"Maak overzicht (ochtend/middag/avond) en detecteer risicomedicatie (anticoagulantia, insuline).",
      uitvoerder:"Verpleegkundige (N6)",
      when:"Binnen 48u",
      triggers: trig(
        "Zorgbundel: Medicatiebegeleiding",
        (data.med_complex ? `Schema: ${data.med_complex}` : null),
        (data.med_confusion ? `Verwarringsrisico: ${data.med_confusion}` : null)
      )
    });

    if(data.med_confusion === "Hoog" || Number(data.med_aantal||0) >= 10 || data.med_review === "Ja"){
      add({
        id:"MED_REVIEW",
        group:"Medicatiebegeleiding",
        title:"Medicatiereview voorstellen",
        detail:"Contacteer huisarts/apotheek voor review (polyfarmacie/risico).",
        uitvoerder:"Verpleegkundige (N6)",
        when:"Binnen 7 dagen",
        triggers: trig(
          "Zorgbundel: Medicatiebegeleiding",
          (Number(data.med_aantal||0) >= 10 ? "Drempel: ‚â•10 medicaties" : null),
          (data.med_confusion === "Hoog" ? "Drempel: verwarringsrisico hoog" : null),
          (data.med_review === "Ja" ? "Keuze: review gevraagd" : null)
        )
      });
    }

    if(data.med_inject){
      add({
        id:"MED_INJECT",
        group:"Medicatiebegeleiding",
        title:"Injectieplan & materiaal",
        detail:"Bevestig frequentie + zelfredzaamheid; organiseer materiaal en visites.",
        uitvoerder:"Thuisverpleegkundige (N4/5)",
        when:"Bij opstart",
        triggers: trig(
          "Signaal: injecties",
          (data.inject_freq ? `Frequentie: ${data.inject_freq}` : null),
          (data.inject_self ? `Zelf: ${data.inject_self}` : null)
        )
      });
    }
  }

  // -------- Mobiliteit & valpreventie --------
  if(hasBundle("Mobiliteit & valpreventie")){
    add({
      id:"VAL_CONFIRM",
      group:"Valpreventie",
      title:"Valrisico-inschatting bevestigen",
      detail:"Val-geschiedenis + letsel + trapcontext kort bevestigen.",
      uitvoerder:"Verpleegkundige (N6)",
      when:"Vandaag",
      triggers: trig(
        "Zorgbundel: Mobiliteit & valpreventie",
        (data.mob_val ? "Signaal: valincident" : null),
        (data.mob_trap ? "Signaal: trappen in woning" : null)
      )
    });

    add({
      id:"MOB_AID",
      group:"Valpreventie",
      title:"Hulpmiddel checken/voorzien",
      detail:"Rollator/rolstoel/tillift: aanwezig? zo niet: aanvraag via mutualiteit/leverancier.",
      uitvoerder:"Ergotherapeut",
      when:"Binnen 72u",
      triggers: trig(
        "Zorgbundel: Mobiliteit & valpreventie",
        (data.mob_hulpmiddel ? `Hulpmiddel: ${data.mob_hulpmiddel}` : null),
        (data.transfer_tools ? `Transferhulpmiddel: ${data.transfer_tools}` : null)
      )
    });

    if(data.soc_alleen && data.mob_val){
      add({
        id:"ALARM_ACT",
        group:"Valpreventie",
        title:"Personenalarm activeren",
        detail:"Voorstel + praktische opstart + contactpersonen instellen.",
        uitvoerder:"Alarmdienst / externe partner",
        when:"Binnen 48u",
        triggers: trig(
          "Combinatie: alleenwonend + valrisico",
          (data.val_alarm_suggest ? `Keuze alarm: ${data.val_alarm_suggest}` : null)
        )
      });
    }
  }

  // -------- Technische thuisverpleging --------
  if(hasBundle("Technische thuisverpleging")){
    add({
      id:"TECH_START",
      group:"Technische zorg",
      title:"Zorgopstart door verpleegkundige",
      detail:"Eerste bezoek: assessment, voorschriften check, plan van aanpak.",
      uitvoerder:"Thuisverpleegkundige (N4/5)",
      when:"Bij opstart",
      triggers: trig(
        "Zorgbundel: Technische thuisverpleging",
        (data.tech_wonde ? "Signaal: wonde" : null),
        (data.tech_decub ? "Signaal: decubitus" : null),
        (data.tech_katheter ? "Signaal: katheter" : null),
        (data.tech_stoma ? "Signaal: stoma" : null)
      )
    });

    if(data.tech_wonde){
      add({
        id:"TECH_WOUND",
        group:"Technische zorg",
        title:"Wondzorgprotocol vastleggen",
        detail:"Type wonde + frequentie + materialen; foto/metingen indien nodig.",
        uitvoerder:"Thuisverpleegkundige (N4/5)",
        when:"Binnen 24‚Äì48u",
        triggers: trig(
          "Signaal: wonde",
          (data.wonde_type ? `Type: ${data.wonde_type}` : null),
          (data.wonde_freq ? `Frequentie: ${data.wonde_freq}` : null)
        )
      });
    }

    if(data.tech_decub){
      add({
        id:"TECH_DECUB",
        group:"Technische zorg",
        title:"Decubitusplan & drukontlasting",
        detail:"Matras/positionering + opvolgfrequentie; escaleer bij stadium 3‚Äì4.",
        uitvoerder:"Thuisverpleegkundige (N4/5)",
        when:"Binnen 24u",
        triggers: trig(
          "Signaal: decubitus",
          (data.decub_stage ? `Stadium: ${data.decub_stage}` : null),
          (data.decub_matras ? `Matras: ${data.decub_matras}` : null)
        )
      });
    }

    if(data.tech_katheter){
      add({
        id:"TECH_KATH",
        group:"Technische zorg",
        title:"Katheterzorg-afspraken",
        detail:"Type + wisselfrequentie + alarmsymptomen afstemmen.",
        uitvoerder:"Thuisverpleegkundige (N4/5)",
        when:"Binnen 72u",
        triggers: trig(
          "Signaal: katheter",
          (data.katheter_type ? `Type: ${data.katheter_type}` : null),
          (data.katheter_prob ? `Problemen: ${data.katheter_prob}` : null)
        )
      });
    }
  }

  // -------- Veiligheid thuis --------
  if(hasBundle("Veiligheid thuis")){
    add({
      id:"SAFE_HOME",
      group:"Veiligheid",
      title:"Veiligheidscheck thuis",
      detail:"Sleutelbeheer/toegang + risico's (dwalen/val) + noodnummers.",
      uitvoerder:"Zorgco√∂rdinator",
      when:"Binnen 48u",
      triggers: trig(
        "Zorgbundel: Veiligheid thuis",
        (data.toegang ? `Toegang: ${data.toegang}` : null),
        (data.cog_veilig ? `Cognitieve veiligheid: ${data.cog_veilig}` : null)
      )
    });

    if(data.cog_veilig === "Hoog" || data.cog_dailycheck === "Ja"){
      add({
        id:"SAFE_DAILY",
        group:"Veiligheid",
        title:"Dagelijks contactmoment organiseren",
        detail:"Dagelijkse check-in (telefonisch of bezoek) volgens afspraak.",
        uitvoerder:"Thuisverpleegkundige (N4/5) / netwerk",
        when:"Binnen 48u",
        triggers: trig(
          "Drempel: cognitieve veiligheid hoog",
          (data.cog_dailycheck ? `Daily check: ${data.cog_dailycheck}` : null)
        )
      });
    }
  }

  // -------- Co√∂rdinatie & netwerk --------
  if(hasBundle("Co√∂rdinatie & netwerkondersteuning")){
    add({
      id:"COORD_NET",
      group:"Co√∂rdinatie",
      title:"Netwerk in kaart brengen",
      detail:"Wie doet wat? Mantelzorger + huisarts + andere hulpverleners.",
      uitvoerder:"Zorgco√∂rdinator",
      when:"Binnen 72u",
      triggers: trig(
        "Zorgbundel: Co√∂rdinatie & netwerkondersteuning",
        (data.soc_alleen ? "Signaal: alleenwonend" : null),
        (data.soc_mantel_overlast ? "Signaal: mantelzorger overbelast" : null),
        (data.soc_taal ? "Signaal: taal/gezondheidsgeletterdheid" : null),
        (data.soc_fin ? "Signaal: financieel" : null)
      )
    });

    if(data.soc_mantel_overlast){
      add({
        id:"COORD_MANTEL",
        group:"Co√∂rdinatie",
        title:"Mantelzorgbelasting bespreken",
        detail:"Duidelijke afspraken, grenzen, respite-opties.",
        uitvoerder:"Zorgco√∂rdinator / sociaal werker",
        when:"Binnen 7 dagen",
        triggers: trig(
          "Signaal: mantelzorger overbelast",
          (data.mantel_reason ? `Reden: ${data.mantel_reason}` : null)
        )
      });
    }

    if(data.soc_taal){
      add({
        id:"COORD_LANG",
        group:"Co√∂rdinatie",
        title:"Communicatie-afspraken",
        detail:"Voorkeurstaal + tolk/ondersteuner vastleggen voor afspraken.",
        uitvoerder:"Zorgco√∂rdinator",
        when:"Vandaag",
        triggers: trig(
          "Signaal: communicatie",
          (data.taal ? `Taal: ${data.taal}` : null),
          (data.tolk ? `Tolk: ${data.tolk}` : null)
        )
      });
    }

    if(data.soc_fin){
      add({
        id:"COORD_FIN",
        group:"Co√∂rdinatie",
        title:"Financieel/administratief spoor",
        detail:"VT/tegemoetkomingen, hulpmiddelen, facturatiekanalen.",
        uitvoerder:"Sociaal werker",
        when:"Binnen 7 dagen",
        triggers: trig("Signaal: financieel")
      });
    }
  }

  return Array.from(byId.values());
}

function groupBy(arr, keyFn){
  const m = new Map();
  arr.forEach(x=>{
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  });
  return m;
}

function renderNiceBundles(bundles){
  bundleList.innerHTML = "";
  bundles.forEach(b=>{
    const pr = b.prio === "hoog" ? "bad" : (b.prio === "matig" ? "warn" : "good");
    const whyHtml = (b.why && b.why.length)
      ? b.why.map(w=> `<span class="whyChip">${escapeHtml(w)}</span>`).join("")
      : `<span class="whyChip">-</span>`;

    const el = document.createElement("div");
    el.className = "bundleCard";
    el.innerHTML = `
      <div class="bundleTop">
        <div class="bundleName">${escapeHtml(b.name)}</div>
        <span class="tag ${pr}">${escapeHtml(b.prio)}</span>
      </div>
      <div class="bundleWhy">${whyHtml}</div>
      <div class="bundleFoot">
        <span>Voorstel (prototype-regels)</span>
        <span>-> Taken automatisch</span>
      </div>
    `;
    bundleList.appendChild(el);
  });
}

function renderTasks(tasks){
  const taskBoard = $("#taskBoard");
  const taskCountPill = $("#taskCountPill");
  taskBoard.innerHTML = "";

  const selectedCount = tasks.filter(t=> t.selected !== false).length;
  taskCountPill.textContent = `${selectedCount} / ${tasks.length} taken (zorgplan)`;

  if(!tasks.length){
    taskBoard.innerHTML = `
      <div class="taskGroup">
        <div class="taskGroupTop">
          <div class="taskGroupTitle">Nog geen taken</div>
          <span class="tag">-</span>
        </div>
        <div class="mini" style="margin-top:8px;">Vink probleemgebieden aan om taken te genereren.</div>
      </div>`;
    return;
  }

  const grouped = groupBy(tasks, t=> t.group || "Algemeen");

  grouped.forEach((items, group)=>{
    const g = document.createElement("div");
    g.className = "taskGroup";

    g.innerHTML = `
      <div class="taskGroupTop">
        <div class="taskGroupTitle">${escapeHtml(group)}</div>
        <span class="tag">${items.length} taken</span>
      </div>
      <div class="taskList">
        ${items.map(t=> {
          const checked = (t.selected !== false) ? "checked" : "";
          const trigHtml = (t.triggers && t.triggers.length)
            ? t.triggers.slice(0,4).map(x=> `<span class="whyChip">${escapeHtml(x)}</span>`).join("")
            : `<span class="whyChip">‚Äî</span>`;
          return `
            <div class="task">
              <div class="tick">‚úì</div>
              <div style="width:100%">
                <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;">
                  <div>
                    <b>${escapeHtml(t.title)}</b>
                    <span>${escapeHtml(t.detail)}</span>
                  </div>
                  <label class="whyChip" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
                    <input type="checkbox" data-task-select="${escapeHtml(t.id)}" ${checked} style="width:auto;margin:0;accent-color:#0b63ce;">
                    In zorgplan
                  </label>
                </div>

                <span style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="whyChip">Uitvoerder: ${escapeHtml(t.uitvoerder || "-")}</span>
                  <span class="whyChip">Timing: ${escapeHtml(t.when || "-")}</span>
                  <span class="whyChip">Co√∂rdinatie: ${escapeHtml(t.coord || "-")}</span>
                </span>

                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                  ${trigHtml}
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;

    taskBoard.appendChild(g);
  });

  // selection handler (delegation)
  taskBoard.querySelectorAll("input[data-task-select]").forEach(inp=>{
    inp.addEventListener("change", (e)=>{
      const id = e.target.getAttribute("data-task-select");
      const out = window.__ZS_OUT;
      if(!out || !out.taken) return;
      const t = out.taken.find(x=> x.id === id);
      if(!t) return;
      t.selected = e.target.checked;
      // refresh counters + JSON + (optioneel) samenvatting
      jsonOut.textContent = JSON.stringify(out, null, 2);
      renderTasks(out.taken);
    });
  });
}

function renderSummary(out){
  $("#sumPatient").textContent = out.patient.naam ? `${out.patient.naam} - ${out.patient.adres || "adres onbekend"}` : "-";
  const pbTop = out.probleemgebieden.slice(0,3).map(p=> `${p.label} (${p.score})`).join(" | ");
  $("#sumPB").textContent = pbTop || "-";
  const approach = out.zorgbundels
    .filter(b=> !b.name.startsWith("Geen bundel"))
    .map(b=> b.name.replace("Zorgbundel: ",""))
    .join(" -> ");
  $("#sumApproach").textContent = approach || "Minimale opvolging";
  $("#sumNote").textContent = out.vrijeOpmerking || "-";
}

// VERVANGT bestaande renderOutput()
function renderOutput(){
  const data = collectData();
  const {pbScores, total, medAantal} = computePB();
  setScoreBasedReveals(pbScores, medAantal);

  const pbKeys = Object.keys(pbScores).sort((a,b)=> (pbScores[b]-pbScores[a]));
  const bundles = suggestBundles(pbScores, data, medAantal);
  const tasks = buildTasks(pbScores, data, bundles);

  const sev = severityTag(total);
  severityBadge.textContent = `Kwetsbaarheid: ${sev.txt}`;
  severityBadge.className = `badge tag ${sev.cls}`;

      // behoud selectie (als gebruiker al taken aan/uit zette)
    const prev = window.__ZS_OUT?.taken || [];
    const selMap = new Map(prev.map(t => [t.id, t.selected !== false]));
    tasks.forEach(t => { if(selMap.has(t.id)) t.selected = selMap.get(t.id); });

  statusBadge.textContent = (total===0) ? "Start" : `Score ${total}`;
  scoreTotalEl.textContent = String(total);
  pbCountEl.textContent = String(pbKeys.length);

  // Build output object
  const out = {
    patient: {
      naam: data.naam || "",
      rrn: data.rrn || "",
      tel: data.tel || "",
      mutualiteit: data.mut || "",
      adres: data.adres || "",
      huisarts: data.huisarts || "",
      mantel: data.mantel || ""
    },
    probleemgebieden: pbKeys.map(k => ({
      key: k,
      label: (PB[k] && PB[k].label) ? PB[k].label : k,
      score: pbScores[k]
    })),
    kwetsbaarheidScore: total,
    zorgbundels: bundles,
    taken: tasks,
    vrijeOpmerking: data.opm || ""
  };

  // Render pretty UI
  renderNiceBundles(bundles);
  renderTasks(tasks);
  renderSummary(out);

  // JSON stays behind tab
  jsonOut.textContent = JSON.stringify(out, null, 2);

  // Default bundels tab should always have content
  if(bundleList.children.length === 0){
    bundleList.innerHTML = `
      <div class="bundleCard">
        <div class="bundleTop">
          <div class="bundleName">Geen bundels (nog)</div>
          <span class="tag">-</span>
        </div>
        <div class="bundleWhy"><span class="whyChip">Vul probleemgebieden in om voorstellen te zien.</span></div>
      </div>`;
  }

  window.__ZS_OUT = out; // bewaart laatste output voor zorgplan
}

function setStep(n){
  // show/hide
  Object.keys(stepEls).forEach(k => stepEls[k].classList.toggle("hidden", Number(k)!==n));

  // update nav states
  stepsNav.forEach(s => {
    const sn = Number(s.getAttribute("data-step"));
    s.classList.toggle("active", sn === n);
    s.classList.toggle("done", sn < n);
  });

  // header text
  if(n===1){
    leftTitle.textContent = "Stap 1 ‚Äî Basis";
    leftSub.textContent = "Vul minimale gegevens in. Daarna ga je naar probleemgebieden.";
  }else if(n===2){
    leftTitle.textContent = "Stap 2 ‚Äî Probleemgebieden";
    leftSub.textContent = "Openklappers verschijnen automatisch. Output rechts wordt live bijgewerkt.";
  }else{
    leftTitle.textContent = "Stap 3 ‚Äî Samenvatting";
    leftSub.textContent = "Kopieer JSON of print naar PDF. (Inhoud komt uit stap 1‚Äì2.)";
  }
  // scroll top of card on step change (nice UX)
  window.scrollTo({top:0, behavior:"smooth"});
}

/* --------------------------
   EVENTS
--------------------------- */
// Accordion
$$(".sec-h").forEach(h => {
  h.addEventListener("click", ()=> toggleSection(h));
  h.addEventListener("keydown", (e)=> {
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggleSection(h); }
  });
});

// Reveal logic + auto-open + LIVE render
form.addEventListener("change", (e) => {
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;

  if(t.matches("input[type=checkbox][data-reveal]")){
    updateRevealForInput(t);
  }
  if(t.matches("input[type=checkbox]")){
    const sec = t.closest(".section");
    if(sec && t.checked) sec.setAttribute("data-open","1");
  }
  updateMeta();
  renderOutput();
});
form.addEventListener("input", () => {
  updateMeta();
  renderOutput();
});

// Init reveal blocks
$$("input[type=checkbox][data-reveal]").forEach(updateRevealForInput);
updateMeta();
renderOutput();

// Wizard controls
$("#next1").addEventListener("click", ()=> setStep(2));
$("#back2").addEventListener("click", ()=> setStep(1));
$("#next2").addEventListener("click", ()=> setStep(3));
$("#back3").addEventListener("click", ()=> setStep(2));

// Click nav steps
stepsNav.forEach(s => {
  s.addEventListener("click", ()=> setStep(Number(s.getAttribute("data-step"))));
  s.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" || e.key===" "){ e.preventDefault(); setStep(Number(s.getAttribute("data-step"))); }
  });
});

// Copy JSON
async function copyJson(){
  const txt = jsonOut.textContent || "{}";
  try{
    await navigator.clipboard.writeText(txt);
    statusBadge.textContent = "JSON gekopieerd ‚úî";
    setTimeout(()=> renderOutput(), 900);
  }catch(err){
    alert("Kopi√´ren lukt niet in deze browser-context. Selecteer en kopieer handmatig.");
  }
}
$("#btnCopy").addEventListener("click", copyJson);
$("#btnFinalCopy").addEventListener("click", copyJson);

// Print/PDF
function doPrint(){ window.print(); }
$("#btnPrint").addEventListener("click", doPrint);
$("#btnFinalPrint").addEventListener("click", doPrint);

// Reset
$("#btnReset").addEventListener("click", () => {
  form.reset();
  // close optional sections except first
  $$(".section").forEach((s,i)=> s.setAttribute("data-open", i===0 ? "1":"0"));
  // hide all reveals
  $$(".reveal").forEach(r => r.setAttribute("data-show","0"));
  setStep(1);
  updateMeta();
  renderOutput();
});

// start at step 1
setStep(1);

                                                // Zorgplan (PDF) functions
function providerLabel(owner){
  const map = {
    "Thuisverpleging": "Thuisverpleegkundige (Altrio / partner)",
    "Verpleegkundige": "Verpleegkundige (N4/5)",
    "Verpleegkundige (N6)": "Verpleegkundige (N6) - supervisie & klinische afstemming",
    "Zorgcoordinator": "Zorgcoordinator / casemanager",
    "Sociaal werker": "Sociaal werker / sociale dienst",
    "Ergotherapeut": "Ergotherapie (hulpmiddelen & woning)",
  };
  return map[owner] || owner || "Onbekend";
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function carePlanHTML(out){
  const today = new Date();
  const d = today.toLocaleDateString("nl-BE", {year:"numeric", month:"long", day:"2-digit"});
  const patientName = out.patient?.naam || "Onbekende patient";
  const addr = out.patient?.adres || "-";
  const tel  = out.patient?.tel || "-";
  const huisarts = out.patient?.huisarts || "-";
  const mantel = out.patient?.mantel || "-";

  const bundles = (out.zorgbundels || []).filter(b => !String(b.name||"").startsWith("Geen bundel"));
  const bundleChips = bundles.length
    ? bundles.map(b => `<span class="zp-chip">${esc(b.name.replace("Zorgbundel: ",""))}</span>`).join("")
    : `<span class="zp-chip">Minimale opvolging</span>`;

      const tasks = (out.taken || []).filter(t => t.selected !== false);
  const grouped = new Map();
  tasks.forEach(t=>{
    const g = t.group || "Algemeen";
    if(!grouped.has(g)) grouped.set(g, []);
    grouped.get(g).push(t);
  });

  const taskBlocks = tasks.length
    ? Array.from(grouped.entries()).map(([group, items]) => {
        const prioTag = (group.toLowerCase().includes("veilig") || group.toLowerCase().includes("val")) ? "Prioriteit" : "Taken";
        return `
          <div class="zp-card">
            <div class="zp-cardtop">
              <b>${esc(group)}</b>
              <span class="zp-tag">${items.length} ${esc(prioTag)}</span>
            </div>
            <div class="zp-tasklist">
              ${items.map(t => `
                <div class="zp-task">
                  <div class="zp-taskline">
                    <b>${esc(t.title)}</b>
                    <span class="zp-tag">${esc(t.when || "-")}</span>
                  </div>
                  <div class="zp-tasksmall">${esc(t.detail || "")}</div>
                  <div class="zp-pillrow">
                    <span class="zp-pill">Uitvoerder: ${esc(t.uitvoerder)}</span>
                    <span class="zp-pill">Co√∂rdinatie: ${esc(t.coord)}</span>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `;
      }).join("")
    : `
      <div class="zp-card">
        <div class="zp-cardtop">
          <b>Geen taken gegenereerd</b>
          <span class="zp-tag">-</span>
        </div>
        <p style="margin:8px 0 0;color:#4b5563;font-size:12px;">Vul probleemgebieden in om automatisch een takenpakket te krijgen.</p>
      </div>
    `;

  const pbTop = (out.probleemgebieden || []).slice(0,5).map(p => `${p.label} (${p.score})`).join(" | ") || "-";

  return `<!doctype html>
  <html lang="nl">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Zorgstart - Zorgplan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body{margin:0;background:#f3f4f6;}
      ${document.querySelector("style")?.innerHTML || ""}
    </style>
  </head>
  <body>
    <div class="zp-wrap">
      <div class="zp-head">
        <div class="zp-title">
          <h1>Zorgplan - ${esc(patientName)}</h1>
          <div class="zp-noprint">
            <button onclick="window.print()" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(17,24,39,.15);background:#fff;font-weight:800;cursor:pointer;">Print / Save as PDF</button>
          </div>
        </div>
        <div class="zp-meta">
          <div class="zp-kv"><div class="zp-k">Datum</div><div class="zp-v">${esc(d)}</div></div>
          <div class="zp-kv"><div class="zp-k">Kwetsbaarheidsscore</div><div class="zp-v">${esc(out.kwetsbaarheidScore ?? "-")}</div></div>
          <div class="zp-kv"><div class="zp-k">Adres</div><div class="zp-v">${esc(addr)}</div></div>
          <div class="zp-kv"><div class="zp-k">Contact</div><div class="zp-v">${esc(tel)}</div></div>
          <div class="zp-kv"><div class="zp-k">Huisarts</div><div class="zp-v">${esc(huisarts)}</div></div>
          <div class="zp-kv"><div class="zp-k">Mantelzorg / contactpersoon</div><div class="zp-v">${esc(mantel)}</div></div>
        </div>
        <div class="zp-chiprow">
          ${bundleChips}
        </div>
      </div>
      <div class="zp-section">
        <h2>Kernsamenvatting</h2>
        <p><b>Top-probleemgebieden:</b> ${esc(pbTop)}</p>
      </div>
      <div class="zp-section">
        <h2>Zorgnetwerk ‚Äî Takenpakket & uitvoerders</h2>
        <p>Onderstaande taken zijn automatisch afgeleid uit probleemgebieden en zorgbundels. Elke taak bevat een aanbevolen uitvoerder/dienstverlener.</p>
        <div class="zp-grid">
          ${taskBlocks}
        </div>
        <div class="zp-footer">Zorgstart - automatisch gegenereerd zorgplan (prototype). Voor klinische finalisatie: verpleegkundige (N6) / zorgcoordinator.</div>
      </div>
    </div>
  </body>
  </html>`;
}

function openCarePlan(){
  const out = window.__ZS_OUT;
  if(!out){
    alert("Nog geen output. Vul eerst de vragenlijst in.");
    return;
  }
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(carePlanHTML(out));
  w.document.close();
}

$("#btnCarePlan").addEventListener("click", openCarePlan);
</script>
</body>
</html>
